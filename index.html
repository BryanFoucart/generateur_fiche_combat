<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Générateur de Combat</title>
  <style>
    body {
      max-width: 1000px;
      margin: auto;
      font-family: Arial;
      padding: 20px;
    }

    #selectGroup {
      display: flex;
      text-align: center;
      padding: 5px;
    }

    div#selectGroup label {
      margin: auto;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    .bloc {
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 20px;
    }

    .capacite-container {
      margin-left: 20px;
      margin-bottom: 10px;
    }

    .companion-container {
      border: 1px dashed #aaa;
      padding: 10px;
      margin-top: 10px;
    }

    textarea {
      width: 100%;
      height: 200px;
      resize: none;
    }

    .tabs {
      display: flex;
      justify-content: center;
      /* margin-bottom: 20px; */
      margin-top: 5px;
    }

    .tab-button {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      cursor: pointer;
      background-color: #eee;
      border: 1px solid #ccc;
      border-bottom: none;
      transition: background-color 0.3s;
    }

    .tab-button.active {
      background-color: white;
      font-weight: bold;
      border-bottom: 2px solid #333;
    }

    #combat-form>div {
      display: none;
      padding: 10px;
      border: 1px solid #ccc;
    }

    #combat-form>.active {
      display: block;
    }

    div li {
      border: 1px black dotted;
      padding: 5px;
      margin-top: 5px;

      & label {
        margin-top: 5px;
      }
    }

    div.character-actions {
      display: flex;
      margin-top: 5px;

      justify-content: space-evenly;
    }

    /* button#btnHTML {
display: flex;
margin: 5px auto;
} */

    button#btnHTML,
    button#btnCopie {
      display: inline-flex;
      margin: 5px;
    }

    .button-container {
      text-align: center;
      margin: 5px auto;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }

    .checkbox-container input[type="checkbox"] {
      margin-right: 8px;
    }

    .checkbox-container label {
      margin-top: 0;
    }

    @media (max-width: 768px) {
      .bloc {
        /* padding: 10px; */
        font-size: 0.875rem;
      }

      label {
        font-size: 0.875rem;
      }

      [type="checkbox"] {
        width: auto;
      }

      /* input,
select,
textarea {
/* font-size: 0.875rem; */
      /* width: 100%; } */

      .tabs {
        flex-direction: column;
      }

      .tab-button {
        border-bottom: 1px solid #ccc;
      }

      #selectGroup {
        display: block;

        label {
          padding-bottom: 5px;
          display: block;

          input {
            width: 50%;
          }
        }
      }
    }

    .character-content {
      display: none;
      padding-top: 10px;
    }

    .bloc h3 {
      cursor: pointer;
      background-color: #f0f0f0;
      padding: 8px;
      margin: -15px -15px 10px -15px;
      border-bottom: 1px solid #ccc;
    }

    .bloc.expanded .character-content {
      display: block;
    }
  </style>
</head>

<body>
  <h2>Générateur de Fiche de Combat</h2>

  <div id="selectGroup">
    <label>Personnages - Groupe 1 :
      <input type="number" id="nbGroupe1" value="1" min="1" onfocus="this.value = '';" onblur="if (!this.value) this.value = 1;" onchange="genererGroupe(1)" style="width: 60px" />
    </label>
    <label>Personnages - Groupe 2 :
      <input type="number" id="nbGroupe2" value="1" min="1" onfocus="this.value = '';" onblur="if (!this.value) this.value = 1;" onchange="genererGroupe(2)" style="width: 60px" />
    </label>
  </div>

  <div style="text-align: center; margin: 10px 0">
    <label>Tour :
      <input type="number" id="numeroTour" value="1" min="1" onfocus="this.value = '';" onblur="if (!this.value) this.value = 1;" style="width: 60px" />
    </label>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('groupe1')">
      Groupe 1
    </button>
    <button class="tab-button" onclick="switchTab('groupe2')">
      Groupe 2
    </button>
  </div>

  <div id="combat-form">
    <div id="groupe1-form"></div>
    <div id="groupe2-form"></div>
  </div>

  <div class="button-container">
    <button onclick="genererHTML()" id="btnHTML">Générer le Code HTML</button>
    <button onclick="copierHTML()" id="btnCopie" style="display: none">
      Copier le Code HTML
    </button>
  </div>

  <h2>Résultat HTML :</h2>
  <textarea id="resultat" readonly></textarea>

  <script>
    function genererGroupe(groupeNum) {
      const nb = parseInt(
        document.getElementById(`nbGroupe${groupeNum}`).value
      );

      // Sauvegarder les données existantes pour chaque personnage du groupe
      const savedCharacters = [];
      for (
        let i = 0; i <
        document.querySelectorAll(`#groupe${groupeNum}-form .bloc`).length; i++
      ) {
        const prefix = `g${groupeNum}_p${i}`;
        const personnage = collecterPersonnage(prefix);
        personnage._tempData = {
          vitaliteDebutCheck: document.getElementById(
            `${prefix}_vitaliteDebutCheck`
          )?.checked,
          vitaliteDebut: document.getElementById(`${prefix}_vitaliteDebut`)
            ?.value,
          vitesseDebutCheck: document.getElementById(
            `${prefix}_vitesseDebutCheck`
          )?.checked,
          vitesseDebut: document.getElementById(`${prefix}_vitesseDebut`)
            ?.value,
          changementVieCheck: document.getElementById(
            `${prefix}_changementVieCheck`
          )?.checked,
          changementVie: document.getElementById(`${prefix}_changementVie`)
            ?.value,
          changementVitesseCheck: document.getElementById(
            `${prefix}_changementVitesseCheck`
          )?.checked,
          changementVitesse: document.getElementById(
            `${prefix}_changementVitesse`
          )?.value,
          changementDegatsCheck: document.getElementById(
            `${prefix}_changementDegatsCheck`
          )?.checked,
          changementDegats: document.getElementById(
            `${prefix}_changementDegats`
          )?.value,
        };
        // Sauvegarder les données temporaires des invocations
        personnage._invocationsTemp = [];
        const compagnons = document.querySelectorAll(`.${prefix}_comp_nom`);
        compagnons.forEach((_, idx) => {
          personnage._invocationsTemp.push({
            changementVieCheck: document.getElementById(
              `${prefix}_comp${idx}_changementVieCheck`
            )?.checked,
            changementVie: document.getElementById(
              `${prefix}_comp${idx}_changementVie`
            )?.value,
            changementVitesseCheck: document.getElementById(
              `${prefix}_comp${idx}_changementVitesseCheck`
            )?.checked,
            changementVitesse: document.getElementById(
              `${prefix}_comp${idx}_changementVitesse`
            )?.value,
            changementDegatsCheck: document.getElementById(
              `${prefix}_comp${idx}_changementDegatsCheck`
            )?.checked,
            changementDegats: document.getElementById(
              `${prefix}_comp${idx}_changementDegats`
            )?.value,
          });
        });

        savedCharacters.push(personnage);
      }

      // Générer le nouveau HTML pour ce groupe
      let html = `<h3>Groupe ${groupeNum}</h3>`;
      for (let i = 0; i < nb; i++) {
        html += createCharacterForm(
          `g${groupeNum}_p${i}`,
          // `Personnage ${i + 1}`
          document.getElementById(`g${groupeNum}_p${i}_nom`)?.value ||
          `Personnage ${i + 1}`
        );
      }
      document.getElementById(`groupe${groupeNum}-form`).innerHTML = html;

      // Restaurer les données pour chaque personnage
      savedCharacters.forEach((personnage, i) => {
        if (i < nb) {
          // Ne restaurer que si le personnage existe toujours
          const prefix = `g${groupeNum}_p${i}`;
          remplirPersonnage(prefix, personnage); // Utilise la fonction existante
          if (personnage._tempData) {
            if (document.getElementById(`${prefix}_vitaliteDebutCheck`)) {
              document.getElementById(
                `${prefix}_vitaliteDebutCheck`
              ).checked = personnage._tempData.vitaliteDebutCheck;
              document.getElementById(`${prefix}_vitaliteDebut`).value =
                personnage._tempData.vitaliteDebut;
            }

            if (document.getElementById(`${prefix}_vitesseDebutCheck`)) {
              document.getElementById(
                `${prefix}_vitesseDebutCheck`
              ).checked = personnage._tempData.vitesseDebutCheck;
              document.getElementById(`${prefix}_vitesseDebut`).value =
                personnage._tempData.vitesseDebut;
            }

            document.getElementById(`${prefix}_changementVieCheck`).checked =
              personnage._tempData.changementVieCheck;
            document.getElementById(`${prefix}_changementVie`).value =
              personnage._tempData.changementVie;
            document.getElementById(
              `${prefix}_changementVitesseCheck`
            ).checked = personnage._tempData.changementVitesseCheck;
            document.getElementById(`${prefix}_changementVitesse`).value =
              personnage._tempData.changementVitesse;
            document.getElementById(
              `${prefix}_changementDegatsCheck`
            ).checked = personnage._tempData.changementDegatsCheck;
            document.getElementById(`${prefix}_changementDegats`).value =
              personnage._tempData.changementDegats;

            if (personnage._tempData.vitaliteDebutCheck) {
              toggleVitaliteDebut(prefix);
            }
            if (personnage._tempData.changementVieCheck) {
              toggleChangementVie(prefix);
            }
            if (personnage._tempData.vitesseDebutCheck) {
              toggleVitesseDebut(prefix);
            }
            if (personnage._tempData.changementVitesseCheck) {
              toggleChangementVitesse(prefix);
            }
            if (personnage._tempData.changementDegatsCheck) {
              toggleChangementDegats(prefix);
            }
          }

          // Restaurer les données temporaires des invocations
          if (personnage._invocationsTemp) {
            document.getElementById(`${prefix}_nbCompagnons`).value =
              personnage._invocationsTemp.length;
            updateCompanions(prefix);
            personnage._invocationsTemp.forEach((invocTemp, idx) => {
              const changementVieCheck = document.getElementById(
                `${prefix}_comp${idx}_changementVieCheck`
              );
              if (changementVieCheck) {
                changementVieCheck.checked = invocTemp.changementVieCheck;
                if (invocTemp.changementVieCheck) {
                  toggleChangementVieCompanion(prefix, idx);
                  document.getElementById(
                    `${prefix}_comp${idx}_changementVie`
                  ).value = invocTemp.changementVie;
                }
              }

              const changementVitesseCheck = document.getElementById(
                `${prefix}_comp${idx}_changementVitesseCheck`
              );
              if (changementVitesseCheck) {
                changementVitesseCheck.checked =
                  invocTemp.changementVitesseCheck;
                if (invocTemp.changementVitesseCheck) {
                  toggleChangementVitesseCompanion(prefix, idx);
                  document.getElementById(
                    `${prefix}_comp${idx}_changementVitesse`
                  ).value = invocTemp.changementVitesse;
                }
              }

              const changementDegatsCheck = document.getElementById(
                `${prefix}_comp${idx}_changementDegatsCheck`
              );
              if (changementDegatsCheck) {
                changementDegatsCheck.checked =
                  invocTemp.changementDegatsCheck;
                if (invocTemp.changementDegatsCheck) {
                  toggleChangementDegatsCompanion(prefix, idx);
                  document.getElementById(
                    `${prefix}_comp${idx}_changementDegats`
                  ).value = invocTemp.changementDegats;
                }
              }
            });
          }
        }
      });
    }

    function genererFormulairesGroupes() {
      const nb1 = parseInt(document.getElementById("nbGroupe1").value);
      const nb2 = parseInt(document.getElementById("nbGroupe2").value);

      // 1. Sauvegarder les données existantes
      const existingData = {};
      const inputs = document.querySelectorAll(
        "#combat-form input, #combat-form select, #combat-form textarea"
      );
      inputs.forEach((input) => {
        if (input.id) {
          existingData[input.id] =
            input.type === "checkbox" ? input.checked : input.value;
        }
      });

      // 2. Générer le HTML pour chaque groupe
      let html1 = `<h3>Groupe 1</h3>`;
      for (let i = 0; i < nb1; i++) {
        html1 += createCharacterForm(
          `g1_p${i}`,
          document.getElementById(`g1_p${i}_nom`)?.value ||
          `Personnage ${i + 1}`
        );
      }
      document.getElementById("groupe1-form").innerHTML = html1;

      let html2 = `<h3>Groupe 2</h3>`;
      for (let i = 0; i < nb2; i++) {
        html2 += createCharacterForm(
          `g2_p${i}`,
          document.getElementById(`g2_p${i}_nom`)?.value ||
          `Personnage ${i + 1}`
        );
      }
      document.getElementById("groupe2-form").innerHTML = html2;

      // 3. Restaurer les données
      for (const id in existingData) {
        const el = document.getElementById(id);
        if (el) {
          if (el.type === "checkbox") {
            el.checked = existingData[id];
            if (el.onchange) el.onchange();
          } else {
            el.value = existingData[id];
            if (el.oninput) el.oninput();
          }
        }
      }
    }

    function createCharacterForm(idPrefix, label) {
      return `
                            <div class="bloc" id="${idPrefix}">
                            <h3 onclick="toggleCharacter('${idPrefix}')">${label}</h3>
                            <div class="character-content">
                            <label>Nom :
                            <input type="text" id="${idPrefix}_nom" onchange="updateCharacterName('${idPrefix}')" onblur="updateCharacterName('${idPrefix}')">
                            </label>
                            <label>Race :
                            <select id="${idPrefix}_classe">
                            <option value="abyssal">Abyssal</option>
                            <option value="djöllfulin">Djöllfulin</option>
                            <option value="elfe">Elfe</option>
                            <option value="entomothrope">Entomothrope</option>
                            <option value="géant">Géant</option>
                            <option value="humain">Humain</option>
                            <option value="hybride">Hybride</option>
                            <option value="naga">Naga</option>
                            <option value="nain">Nain</option>
                            <option value="orc">Orc</option>
                            <option value="stryge-blanc">Stryge Blanc</option>
                            <option value="stryge-noir">Stryge Noir</option>
                            <option value="thérianthrope">Thérianthrope</option>
                            <option value="vampire">Vampire</option>
                            <option value="bestiaire-nom">Créature</option>
                            <option value="boss">Boss</option>
                            <option value="archi-boss">Archi-Boss</option>
                            </select>
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_invisible" onchange="toggleInvisible('${idPrefix}')"> Invisible ?
                            </label>
                            </div>
                            <label>Vitalité :
                            <input type="number" id="${idPrefix}_vitalite" value="0" onClick="if(this.value==='0')this.value=''" oninput="updateVitaliteDebut('${idPrefix}')">
                            </label>
                            <div class="checkbox-container">
                <input type="checkbox" id="${idPrefix}_vitaliteDebutCheck" onchange="toggleVitaliteDebut('${idPrefix}')">
                <label for="${idPrefix}_vitaliteDebutCheck">Vitalité début de combat ?</label>
                </div>
                <div id="${idPrefix}_vitaliteDebutBloc" style="display: none;">
                <label>Vitalité début de combat :
                <input type="text" id="${idPrefix}_vitaliteDebut" oninput="updateVitaliteDebut('${idPrefix}')">
                </label>
                </div>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_changementVieCheck" onchange="toggleChangementVie('${idPrefix}')"> Bonus/Malus - Vitalité ?
                            </label>
                            </div>
                            <div id="${idPrefix}_changementVieBloc" style="display: none;">
                            <label>Bonus/Malus - Vitalité :
                            <input type="text" id="${idPrefix}_changementVie">
                            </label>
                            </div>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_auraCheck" onchange="toggleAura('${idPrefix}')"> Aura ?
                            </label>
                            </div>
                            <div id="${idPrefix}_auraBloc" style="display: none;">
                            <label>Aura :
                            <input type="number" id="${idPrefix}_aura" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            </div>
                            <label>Vitesse :
      <input type="number" id="${idPrefix}_vitesse" value="0" onClick="if(this.value==='0')this.value=''" oninput="updateVitesseDebut('${idPrefix}')">
    </label>
    <div class="checkbox-container">
      <input type="checkbox" id="${idPrefix}_vitesseDebutCheck" onchange="toggleVitesseDebut('${idPrefix}')">
      <label for="${idPrefix}_vitesseDebutCheck">Vitesse début de combat ?</label>
    </div>
    <div id="${idPrefix}_vitesseDebutBloc" style="display: none;">
      <label>Vitesse début de combat :
        <input type="text" id="${idPrefix}_vitesseDebut" oninput="updateVitesseDebut('${idPrefix}')">
      </label>
    </div>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_changementVitesseCheck" onchange="toggleChangementVitesse('${idPrefix}')"> Bonus/Malus - Vitesse ?
                            </label>
                            </div>
                            <div id="${idPrefix}_changementVitesseBloc" style="display: none;">
                            <label>Bonus/Malus - Vitesse :
                            <input type="text" id="${idPrefix}_changementVitesse">
                            </label>
                            </div>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_corrompu" onchange="toggleAbsorption('${idPrefix}')"> Corrompu ?
                            </label>
                            </div>
                            <div id="${idPrefix}_absorptionBloc" style="display: none;">
                            <label>Absorption (%) :
                            <input type="number" id="${idPrefix}_absorption" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_changementAbsorptionCheck" onchange="toggleChangementAbsorption('${idPrefix}')"> Bonus/Malus Absorption ?
                            </label>
                            </div>
                            <div id="${idPrefix}_changementAbsorptionBloc" style="display: none;">
                            <label>Bonus/Malus - Absorption :
                            <input type="number" id="${idPrefix}_changementAbsorption">
                            </label>
                            </div>
                            </div>
                            <label>Dégâts :
                            <input type="number" id="${idPrefix}_degats" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${idPrefix}_changementDegatsCheck" onchange="toggleChangementDegats('${idPrefix}')"> Bonus/Malus - Dégâts ?
                            </label>
                            </div>
                            <div id="${idPrefix}_changementDegatsBloc" style="display: none;">
                            <label>Bonus/Malus - Dégâts:
                            <input type="text" id="${idPrefix}_changementDegats">
                            </label>
                            </div>

                            <label>Capacités spéciales (format : "x Titre : Description", un x en début de chaque compétence) :
                            <textarea id="${idPrefix}_capacites_input" oninput="parseCapacites('${idPrefix}')" placeholder="EXEMPLE
                            x Rapidité : permet d'attaquer à deux reprises.
                            x Hydro cyno : Régénère la vitalité lorsqu'elle atteint 25%.
                            x Attache ensablée : À chaque attache réussie, la cible s'affaiblit et réduit les dégâts de sa prochaine attaque à hauteur de 10% des dégâts du corrompu. Non réalisable dans la région des 'Mers & Océans'."></textarea>
                            </label>
                            <div id="${idPrefix}_capacites"></div>

                            <label>Nombre d'invocations :
                            <input type="number" id="${idPrefix}_nbCompagnons" value="0" min="0" onClick="if(this.value==='0')this.value=''" onchange="updateCompanions('${idPrefix}')">
                            </label>
                            <div id="${idPrefix}_compagnons"></div>

                            <div class="character-actions">
                            <button onclick="exporterPersonnage('${idPrefix}')">Exporter ce personnage</button>
                            <input type="file" id="${idPrefix}_import" accept=".json,application/json" onchange="importerPersonnage(event, '${idPrefix}')" style="display: none;">
                            <button onclick="document.getElementById('${idPrefix}_import').click()">Importer un personnage</button>
                            </div>
                            </div>
                            </div>
                            `;
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function parseCapacites(prefix) {
      const input = document.getElementById(
        `${prefix}_capacites_input`
      ).value;
      const container = document.getElementById(`${prefix}_capacites`);
      container.innerHTML = ""; // Reset

      const lines = input
        .split("\n")
        .map((l) => l.trim())
        .filter((l) => l !== "");

      const entries = [];
      let currentLine = null;

      lines.forEach((line) => {
        if (line.startsWith("x ")) {
          // Nouvelle capacité
          if (currentLine !== null) {
            entries.push(currentLine);
          }
          currentLine = line.substring(2); // Retire le "x "
        } else if (currentLine !== null) {
          currentLine += "\n" + line; // Ajoute la ligne suivante à la description
        }
      });

      if (currentLine !== null) {
        entries.push(currentLine); // Ajouter la dernière
      }

      entries.forEach((entry, index) => {
        const firstColonIndex = entry.indexOf(":");

        if (firstColonIndex !== -1) {
          const titre = entry.substring(0, firstColonIndex).trim();
          const description = entry.substring(firstColonIndex + 1).trim();
          const escapedTitre = escapeHtml(titre);
          const escapedDescription = escapeHtml(description);

          container.innerHTML += `
                            <li>
                            <input type="hidden" class="${prefix}_titreCapacite" value="${escapedTitre}">
                            <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedDescription}">
                            <em>${escapedTitre}</em> : ${escapedDescription}
                            <br>
                            <label>État :
                            <select class="${prefix}_classeCapacite">
                            <option value="capacité_spéciale">Neutre</option>
                            <option value="capacité_spéciale active">Active</option>
                            <option value="capacité_spéciale passive">Passive</option>
                            <option value="capacité_spéciale bloquée">Bloquée</option>
                            <option value="capacité_spéciale utilisée">Utilisée</option>
                            <option value="capacité_spéciale annulée">Annulée</option>
                            <option value="capacité_spéciale inactive">Inactive</option>
                            </select>
                            </label>
                            </li>`;
        } else {
          const escapedLine = escapeHtml(entry);
          container.innerHTML += `
                            <li>
                            <input type="hidden" class="${prefix}_titreCapacite" value="Capacité ${
              index + 1
            }">
                            <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedLine}">
                            <em>Capacité ${index + 1}</em> : ${escapedLine}
                            <br>
                            <label>État :
                            <select class="${prefix}_classeCapacite">
                            <option value="capacité_spéciale">Neutre</option>
                            <option value="capacité_spéciale active">Active</option>
                            <option value="capacité_spéciale passive">Passive</option>
                            <option value="capacité_spéciale bloquée">Bloquée</option>
                            <option value="capacité_spéciale utilisée">Utilisée</option>
                            <option value="capacité_spéciale annulée">Annulée</option>
                            <option value="capacité_spéciale inactive">Inactive</option>
                            </select>
                            </label>
                            </li>`;
        }
      });
    }

    function updateCompanions(prefix) {
      const nb = parseInt(
        document.getElementById(`${prefix}_nbCompagnons`).value
      );
      const container = document.getElementById(`${prefix}_compagnons`);

      // Sauvegarder les données existantes des invocations
      const existingCompanions = [];
      const currentCompanions = container.getElementsByClassName(
        "companion-container"
      );
      Array.from(currentCompanions).forEach((comp, idx) => {
        const companion = {
          nom: comp.querySelector(`.${prefix}_comp_nom`)?.value || "",
          race: comp.querySelector(`.${prefix}_comp_race`)?.value || "",
          vitalite: comp.querySelector(`.${prefix}_comp_vitalite`)?.value || "",
          changementVieCheck: comp.querySelector(`#${prefix}_comp${idx}_changementVieCheck`)
            ?.checked || false,
          changementVie: comp.querySelector(`#${prefix}_comp${idx}_changementVie`)
            ?.value || "",
          auraCheck: document.getElementById(`${prefix}_comp${idx}_auraCheck`)
            ?.checked || false,
          aura: document.getElementById(`${prefix}_comp${idx}_aura`)?.value ||
            "0",
          vitesse: comp.querySelector(`.${prefix}_comp_vitesse`)?.value || "",
          changementVitesseCheck: comp.querySelector(`#${prefix}_comp${idx}_changementVitesseCheck`)
            ?.checked || false,
          changementVitesse: comp.querySelector(`#${prefix}_comp${idx}_changementVitesse`)
            ?.value || "",
          degats: comp.querySelector(`.${prefix}_comp_degats`)?.value || "",
          changementDegatsCheck: comp.querySelector(`#${prefix}_comp${idx}_changementDegatsCheck`)
            ?.checked || false,
          changementDegats: comp.querySelector(`#${prefix}_comp${idx}_changementDegats`)
            ?.value || "",
          capacites: comp.querySelector(`#${prefix}_comp${idx}_capacites_input`)
            ?.value || "",
        };
        existingCompanions.push(companion);
      });

      // Générer le nouveau HTML
      container.innerHTML = "";
      for (let i = 0; i < nb; i++) {
        const existingData = existingCompanions[i] || {};
        container.innerHTML += `
                            <div class="companion-container">
                            <h4 id="${prefix}_comp${i}_title">${
            existingData.nom || `Invocation ${i + 1}`
          }</h4>
                            <label>Nom :
                            <input type="text"
                            class="${prefix}_comp_nom"
                            value="${existingData.nom || ""}"
                            onchange="updateCompanionName('${prefix}', ${i})"
                            onblur="updateCompanionName('${prefix}', ${i})">
                            </label>
                            <label>Race :
                            <input type="text" class="${prefix}_comp_race" value="invocation" hidden>Invocation
                            </label>
                            <label>Vitalité :
                            <input type="number" class="${prefix}_comp_vitalite" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${prefix}_comp${i}_changementVieCheck" onchange="toggleChangementVieCompanion('${prefix}', ${i})"> Bonus/Malus - Vitalité ?
                            </label>
                            </div>
                            <div id="${prefix}_comp${i}_changementVieBloc" style="display: none;">
                            <label>Bonus/Malus - Vitalité :
                            <input type="text" id="${prefix}_comp${i}_changementVie">
                            </label>
                            </div>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${prefix}_comp${i}_auraCheck" onchange="toggleAuraCompanion('${prefix}', ${i})"> Aura ?
                            </label>
                            </div>
                            <div id="${prefix}_comp${i}_auraBloc" style="display: none;">
                            <label>Aura :
                            <input type="number" id="${prefix}_comp${i}_aura" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            </div>
                            <label>Vitesse :
                            <input type="number" class="${prefix}_comp_vitesse" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${prefix}_comp${i}_changementVitesseCheck" onchange="toggleChangementVitesseCompanion('${prefix}', ${i})"> Bonus/Malus - Vitesse ?
                            </label>
                            </div>
                            <div id="${prefix}_comp${i}_changementVitesseBloc" style="display: none;">
                            <label>Bonus/Malus - Vitesse :
                            <input type="text" id="${prefix}_comp${i}_changementVitesse">
                            </label>
                            </div>
                            <label>Dégâts :
                            <input type="number" class="${prefix}_comp_degats" value="0" onClick="if(this.value==='0')this.value=''">
                            </label>
                            <div class="checkbox-container">
                            <label>
                            <input type="checkbox" id="${prefix}_comp${i}_changementDegatsCheck" onchange="toggleChangementDegatsCompanion('${prefix}', ${i})"> Bonus/Malus - Dégâts ?
                            </label>
                            </div>
                            <div id="${prefix}_comp${i}_changementDegatsBloc" style="display: none;">
                            <label>Bonus/Malus - Dégâts :
                            <input type="text" id="${prefix}_comp${i}_changementDegats">
                            </label>
                            </div>
                            <label>Capacités spéciales (format : "x Titre : Description", un x en début de chaque compétence) :
                            <textarea id="${prefix}_comp${i}_capacites_input" oninput="parseCapacitesInvocations('${prefix}', ${i})" placeholder="EXEMPLE
                            x Rapidité : permet d'attaquer à deux reprises.
                            x Hydro cyno : Régénère la vitalité lorsqu'elle atteint 25%.
                            x Attache ensablée : À chaque attache réussie, la cible s'affaiblit et réduit les dégâts de sa prochaine attaque à hauteur de 10% des dégâts du corrompu. Non réalisable dans la région des 'Mers & Océans'."></textarea>
                            </label>
                            <div id="${prefix}_comp${i}_capacites"></div>
                            </div>
                            `;
      }

      // Restaurer les données sauvegardées
      existingCompanions.forEach((comp, idx) => {
        if (idx < nb) {
          const inputNom = document.querySelectorAll(`.${prefix}_comp_nom`)[
            idx
          ];
          // Ne restaurer que si l'invocation existe toujours
          const newContainer = container.children[idx];
          if (newContainer) {
            newContainer.querySelector(`.${prefix}_comp_nom`).value =
              comp.nom;
            newContainer.querySelector(`.${prefix}_comp_race`).value =
              comp.race;
            newContainer.querySelector(`.${prefix}_comp_vitalite`).value =
              comp.vitalite;

            const changementVieCheck = newContainer.querySelector(
              `#${prefix}_comp${idx}_changementVieCheck`
            );

            if (changementVieCheck) {
              changementVieCheck.checked = comp.changementVieCheck;
              if (comp.changementVieCheck) {
                toggleChangementVieCompanion(prefix, idx);
                newContainer.querySelector(
                  `#${prefix}_comp${idx}_changementVie`
                ).value = comp.changementVie;
              }
            }

            const auraCheck = document.getElementById(
              `${prefix}_comp${idx}_auraCheck`
            );
            if (auraCheck) {
              auraCheck.checked = comp.auraCheck;
              document.getElementById(`${prefix}_comp${idx}_aura`).value =
                comp.aura;
              if (comp.auraCheck) {
                toggleAuraCompanion(prefix, idx);
              }
            }

            newContainer.querySelector(`.${prefix}_comp_vitesse`).value =
              comp.vitesse;
            const changementVitesseCheck = newContainer.querySelector(
              `#${prefix}_comp${idx}_changementVitesseCheck`
            );
            if (changementVitesseCheck) {
              changementVitesseCheck.checked = comp.changementVitesseCheck;
              if (comp.changementVitesseCheck) {
                toggleChangementVitesseCompanion(prefix, idx);
                newContainer.querySelector(
                  `#${prefix}_comp${idx}_changementVitesse`
                ).value = comp.changementVitesse;
              }
            }

            newContainer.querySelector(`.${prefix}_comp_degats`).value =
              comp.degats;

            const changementDegatsCheck = newContainer.querySelector(
              `#${prefix}_comp${idx}_changementDegatsCheck`
            );
            if (changementDegatsCheck) {
              changementDegatsCheck.checked = comp.changementDegatsCheck;
              if (comp.changementDegatsCheck) {
                toggleChangementDegatsCompanion(prefix, idx);
                newContainer.querySelector(
                  `#${prefix}_comp${idx}_changementDegats`
                ).value = comp.changementDegats;
              }
            }

            const capacitesInput = newContainer.querySelector(
              `#${prefix}_comp${idx}_capacites_input`
            );
            if (capacitesInput) {
              capacitesInput.value = comp.capacites;
              parseCapacitesInvocations(prefix, idx);
            }
          }
          if (inputNom) {
            input.value = comp.nom || "";
            updateCompanionName(prefix, idx); // Utiliser la fonction existante
          }
        }
      });
    }

    function parseCapacitesInvocations(prefix, idx) {
      const input = document.getElementById(
        `${prefix}_comp${idx}_capacites_input`
      ).value;
      const container = document.getElementById(
        `${prefix}_comp${idx}_capacites`
      );
      container.innerHTML = ""; // Reset

      const lines = input
        .split("\n")
        .map((l) => l.trim())
        .filter((l) => l !== "");

      const entries = [];
      let currentLine = null;

      lines.forEach((line) => {
        if (line.startsWith("x ")) {
          if (currentLine !== null) {
            entries.push(currentLine);
          }
          currentLine = line.substring(2); // Retire le "x "
        } else if (currentLine !== null) {
          currentLine += "\n" + line;
        } else {
          // Si pas de "x" au début, traiter comme une ligne normale
          currentLine = line;
        }
      });

      if (currentLine !== null) {
        entries.push(currentLine);
      }

      entries.forEach((entry, index) => {
        const firstColonIndex = entry.indexOf(":");

        if (firstColonIndex !== -1) {
          const titre = entry.substring(0, firstColonIndex).trim();
          const description = entry.substring(firstColonIndex + 1).trim();
          const escapedTitre = escapeHtml(titre);
          const escapedDescription = escapeHtml(description);

          container.innerHTML += `
                            <li>
                            <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="${escapedTitre}">
                            <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedDescription}">
                            <em>${escapedTitre}</em> : ${escapedDescription}
                            <br>
                            <label>État :
                            <select class="${prefix}_comp${idx}_classeCapacite">
                            <option value="capacité_spéciale">Neutre</option>
                            <option value="capacité_spéciale active">Active</option>
                            <option value="capacité_spéciale passive">Passive</option>
                            <option value="capacité_spéciale bloquée">Bloquée</option>
                            <option value="capacité_spéciale utilisée">Utilisée</option>
                            <option value="capacité_spéciale annulée">Annulée</option>
                            <option value="capacité_spéciale inactive">Inactive</option>
                            </select>
                            </label>
                            </li>`;
        } else {
          const escapedLine = escapeHtml(entry);
          container.innerHTML += `
                            <li>
                            <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="Capacité ${
              index + 1
            }">
                            <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedLine}">
                            <em>Capacité ${index + 1}</em> : ${escapedLine}
                            <br>
                            <label>État :
                            <select class="${prefix}_comp${idx}_classeCapacite">
                            <option value="capacité_spéciale">Neutre</option>
                            <option value="capacité_spéciale active">Active</option>
                            <option value="capacité_spéciale passive">Passive</option>
                            <option value="capacité_spéciale bloquée">Bloquée</option>
                            <option value="capacité_spéciale utilisée">Utilisée</option>
                            <option value="capacité_spéciale annulée">Annulée</option>
                            <option value="capacité_spéciale inactive">Inactive</option>
                            </select>
                            </label>
                            </li>`;
        }
      });
    }

    function extractCharacter(prefix) {
      const vitaliteFinale = updateVitaliteDebut(prefix);
      const vitesseFinale = updateVitesseDebut(prefix);

      let html = `\n${
          document.getElementById(`${prefix}_classe`).value === "boss"
            ? `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }"> <i class="icon boss" title="{BOSS}"></i> `
            : document.getElementById(`${prefix}_classe`).value === "archi-boss"
            ? `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }"> <i class="icon archi-boss" title="{ARCHI-BOSS}"></i> `
            : `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }">`
        }${
          document.getElementById(`${prefix}_nom`).value
        }</strong> : <strong class="vitalité">${vitaliteFinale}</strong>`;

      if (document.getElementById(`${prefix}_changementVieCheck`).checked) {
        const valeurComplete = document.getElementById(
          `${prefix}_changementVie`
        ).value;
        // Séparer les différentes valeurs par les espaces et traiter chaque valeur
        const valeurs = valeurComplete
          .split(" ")
          .filter((val) => val.trim() !== "");

        valeurs.forEach((valeur) => {
          valeur = valeur.trim();
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else if (valeur.startsWith("+")) {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">+${valeur}</strong>`;
          }
        });
      }

      // Ajouter l'état invisible après la vitalité
      if (document.getElementById(`${prefix}_invisible`).checked) {
        html += ` <span style="color: #49B">{Invisible}</span>`;
      }

      if (document.getElementById(`${prefix}_auraCheck`).checked) {
        const valeur = document.getElementById(`${prefix}_aura`).value;
        html += `\n<span class="bestiaire-champ">Aura</span> : <strong class="aura">${valeur}</strong>`;
      }

      html += `\n<span class="bestiaire-champ">Vitesse</span> : <strong class="vitesse">${vitesseFinale}</strong>`;

      if (
        document.getElementById(`${prefix}_changementVitesseCheck`).checked
      ) {
        const valeurComplete = document.getElementById(
          `${prefix}_changementVitesse`
        ).value;
        // Séparer les différentes valeurs par les espaces et traiter chaque valeur
        const valeurs = valeurComplete
          .split(" ")
          .filter((val) => val.trim() !== "");

        valeurs.forEach((valeur) => {
          valeur = valeur.trim();
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else if (valeur.startsWith("+")) {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">+${valeur}</strong>`;
          }
        });
      }

      if (document.getElementById(`${prefix}_corrompu`).checked) {
        html += `\n<span class="bestiaire-champ">Absorption</span> : <strong class="dégâts">${
            document.getElementById(`${prefix}_absorption`).value
          }%</strong>`;

        if (
          document.getElementById(`${prefix}_changementAbsorptionCheck`)
          .checked
        ) {
          const valeur = document.getElementById(
            `${prefix}_changementAbsorption`
          ).value;
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}%</strong>`;
          } else if (valeur.startsWith("+")) {
            html += ` <strong class="stat-bonus">${valeur}%</strong>`;
          } else {
            html += ` <strong class="stat-bonus">+${valeur}%</strong>`;
          }
        }
      }

      // Calculer les dégâts en fonction de l'absorption si nécessaire
      let degats = document.getElementById(`${prefix}_degats`).value;
      if (
        document.getElementById(`${prefix}_corrompu`).checked &&
        (!degats || degats === "0")
      ) {
        const vitalite =
          parseInt(document.getElementById(`${prefix}_vitalite`).value) || 0;
        const absorption =
          parseInt(document.getElementById(`${prefix}_absorption`).value) ||
          0;
        degats = Math.ceil((vitalite * absorption) / 100);
        // Mettre à jour le champ dégâts avec la valeur calculée
        document.getElementById(`${prefix}_degats`).value = degats;
      }

      html += `\n<span class="bestiaire-champ">Dégâts</span> : <strong class="dégâts">${degats}</strong>`;

      if (
        document.getElementById(`${prefix}_changementDegatsCheck`).checked
      ) {
        const valeurComplete = document.getElementById(
          `${prefix}_changementDegats`
        ).value;
        // Séparer les différentes valeurs par les espaces et traiter chaque valeur
        const valeurs = valeurComplete
          .split(" ")
          .filter((val) => val.trim() !== "");

        valeurs.forEach((valeur) => {
          valeur = valeur.trim();
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else if (valeur.startsWith("+")) {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">+${valeur}</strong>`;
          }
        });
      }

      html += `\n<span class="bestiaire-champ">Capacités spéciales</span> :`;

      const titres = Array.from(
        document.getElementsByClassName(`${prefix}_titreCapacite`)
      );
      const descs = Array.from(
        document.getElementsByClassName(`${prefix}_descriptionCapacite`)
      );
      const classes = Array.from(
        document.getElementsByClassName(`${prefix}_classeCapacite`)
      );

      if (titres.length > 0) {
        html += `\n<ul>`;
        for (let i = 0; i < titres.length; i++) {
          const titreNettoye = titres[i].value.replace(/^x\s*/i, "");
          html += `<li class="${classes[i].value}"><em>${titreNettoye}</em> : ${descs[i].value}</li>\n`;
        }
        html += `</ul>`;
      } else {
        html += ` <em>Aucune capacité spéciale</em>`;
      }

      // Partie compagnon

      const noms = document.querySelectorAll(`.${prefix}_comp_nom`);
      const races = document.querySelectorAll(`.${prefix}_comp_race`);
      noms.forEach((compNom, idx) => {
        const race =
          document.querySelectorAll(`.${prefix}_comp_race`)[idx]?.value ||
          "Compagnon"; // Sélectionner la classe pour chaque compagnon
        const vit = document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx]
          .value;
        const vitess = document.querySelectorAll(`.${prefix}_comp_vitesse`)[
          idx
        ].value;
        const deg = document.querySelectorAll(`.${prefix}_comp_degats`)[idx]
          .value;

        html += `\n<strong class="${race}">${compNom.value}</strong> : <strong class="vitalité">${vit}</strong>`;

        // Ajouter les bonus/malus de vie
        if (
          document.getElementById(`${prefix}_comp${idx}_changementVieCheck`)
          .checked
        ) {
          const valeurComplete = document.getElementById(
            `${prefix}_comp${idx}_changementVie`
          ).value;
          // Séparer les différentes valeurs par les espaces et traiter chaque valeur
          const valeurs = valeurComplete
            .split(" ")
            .filter((val) => val.trim() !== "");

          valeurs.forEach((valeur) => {
            valeur = valeur.trim();
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else if (valeur.startsWith("+")) {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">+${valeur}</strong>`;
            }
          });
        }

        if (
          document.getElementById(`${prefix}_comp${idx}_auraCheck`).checked
        ) {
          const valeur = document.getElementById(
            `${prefix}_comp${idx}_aura`
          ).value;
          html += `\n<span class="bestiaire-champ">Aura</span> :<strong class="aura">${valeur}</strong>`;
        }

        html += `\n<span class="bestiaire-champ">Vitesse</span> : <strong class="vitesse">${vitess}</strong>`;

        // Ajouter les bonus/malus de vitesse
        if (
          document.getElementById(
            `${prefix}_comp${idx}_changementVitesseCheck`
          ).checked
        ) {
          const valeurComplete = document.getElementById(
            `${prefix}_comp${idx}_changementVitesse`
          ).value;
          // Séparer les différentes valeurs par les espaces et traiter chaque valeur
          const valeurs = valeurComplete
            .split(" ")
            .filter((val) => val.trim() !== "");

          valeurs.forEach((valeur) => {
            valeur = valeur.trim();
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else if (valeur.startsWith("+")) {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">+${valeur}</strong>`;
            }
          });
        }

        html += `\n<span class="bestiaire-champ">Dégâts</span> : <strong class="dégâts">${deg}</strong>`;

        // Ajouter les bonus/malus de dégâts
        if (
          document.getElementById(
            `${prefix}_comp${idx}_changementDegatsCheck`
          ).checked
        ) {
          const valeurComplete = document.getElementById(
            `${prefix}_comp${idx}_changementDegats`
          ).value;
          // Séparer les différentes valeurs par les espaces et traiter chaque valeur
          const valeurs = valeurComplete
            .split(" ")
            .filter((val) => val.trim() !== "");

          valeurs.forEach((valeur) => {
            valeur = valeur.trim();
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else if (valeur.startsWith("+")) {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">+${valeur}</strong>`;
            }
          });
        }

        html += `\n<span class="bestiaire-champ">Capacités spéciales</span> : `;

        const comp_titles = document.querySelectorAll(
          `.${prefix}_comp${idx}_titreCapacite`
        );
        const comp_descs = document.querySelectorAll(
          `.${prefix}_comp${idx}_descriptionCapacite`
        );
        const comp_classes = document.querySelectorAll(
          `.${prefix}_comp${idx}_classeCapacite`
        );

        // Correction de "lenght" en "length"
        if (comp_titles.length > 0) {
          html += `\n<ul>`;
          for (let i = 0; i < comp_titles.length; i++) {
            html += `<li class="${comp_classes[i].value}"><em>${comp_titles[i].value}</em> : ${comp_descs[i].value}</li>\n`;
          }
          html += `</ul>`;
        } else {
          html += ` <em>Aucune capacité spéciale</em>`;
        }
      });
      return html;
    }

    function calculerVitesseTotale(prefix) {
      let totalVitesse = parseInt(
        document.getElementById(`${prefix}_vitesse`).value || 0
      );
      const compagnons = document.querySelectorAll(`.${prefix}_comp_vitesse`);
      compagnons.forEach((v) => (totalVitesse += parseInt(v.value || 0)));
      return totalVitesse;
    }

    function genererHTML() {
      const nb1 = parseInt(document.getElementById("nbGroupe1").value);
      const nb2 = parseInt(document.getElementById("nbGroupe2").value);

      let vitesseGroupe1 = 0;
      let vitesseGroupe2 = 0;

      let htmlG1 = ``;
      for (let i = 0; i < nb1; i++) {
        const prefix = `g1_p${i}`;
        htmlG1 += extractCharacter(prefix) + "\n";
        vitesseGroupe1 += calculerVitesseTotale(prefix);
      }

      let vitesseG1 =
        nb1 > 1 ?
        `Vitesse de Groupe 1 : ${vitesseGroupe1}` :
        `Vitesse de ${
                document.getElementById("g1_p0_nom").value
              } : ${vitesseGroupe1}`;

      let htmlG2 = ``;
      for (let i = 0; i < nb2; i++) {
        const prefix = `g2_p${i}`;
        htmlG2 += extractCharacter(prefix) + "\n";
        vitesseGroupe2 += calculerVitesseTotale(prefix);
      }

      let vitesseG2 =
        nb2 > 1 ?
        `Vitesse de Groupe 2 : ${vitesseGroupe2}` :
        `Vitesse de ${
                document.getElementById("g2_p0_nom").value
              } : ${vitesseGroupe2}`;

      const commence =
        vitesseGroupe1 >= vitesseGroupe2 ?
        nb1 > 1 ?
        "Groupe 1" :
        document.getElementById("g1_p0_nom").value :
        nb2 > 1 ?
        "Groupe 2" :
        document.getElementById("g2_p0_nom").value;

      const numeroTour = document.getElementById("numeroTour").value;
      const headerTitle =
        nb1 > 1 && nb2 > 1 ?
        `Groupe 1 contre Groupe 2 [T${numeroTour}]` :
        `${
                nb1 === 1
                  ? document.getElementById("g1_p0_nom").value
                  : "Groupe 1"
              } contre ${
                nb2 === 1
                  ? document.getElementById("g2_p0_nom").value
                  : "Groupe 2"
              } [T${numeroTour}]`;

      const header = `<div class="titre">${headerTitle}</div>

                            <em>${commence} commence le combat</em>`;

      document.getElementById(
        "resultat"
      ).value = `${header}\n\n${vitesseG1}\n${htmlG1}\n\n<div class="combat-séparation">Contre</div>\n\n${vitesseG2}\n${htmlG2}`;

      document.getElementById("btnCopie").style.display = "inline-flex";
    }

    function copierHTML() {
      const texte = document.getElementById("resultat");

      // Sélectionner le texte
      texte.select();
      texte.setSelectionRange(0, 99999); // Pour mobile

      try {
        // Essayer d'abord avec l'API Clipboard moderne
        navigator.clipboard
          .writeText(texte.value)
          .then(
            () => {
              montrerFeedback();
            },
            () => {
              // Si ça échoue, utiliser la méthode fallback
              document.execCommand("copy");
              montrerFeedback();
            }
          )
          .catch(() => {
            // Si tout échoue, utiliser la méthode de secours
            document.execCommand("copy");
            montrerFeedback();
          });
      } catch (err) {
        // Dernière tentative avec execCommand
        document.execCommand("copy");
        montrerFeedback();
      }
    }

    // Fonction séparée pour le feedback visuel
    function montrerFeedback() {
      const btnCopie = document.getElementById("btnCopie");
      const texteOriginal = btnCopie.textContent;
      btnCopie.textContent = "Copié !";
      setTimeout(() => {
        btnCopie.textContent = texteOriginal;
      }, 2000);
    }

    function toggleAbsorption(prefix) {
      const bloc = document.getElementById(`${prefix}_absorptionBloc`);
      const isChecked = document.getElementById(`${prefix}_corrompu`).checked;
      bloc.style.display = isChecked ? "block" : "none";

      const updateDegats = () => {
        if (isChecked) {
          const vitalite =
            parseInt(document.getElementById(`${prefix}_vitalite`).value) ||
            0;
          let absorptionValue =
            parseInt(document.getElementById(`${prefix}_absorption`).value) ||
            0;

          // Prendre en compte le bonus/malus d'absorption
          const bonusMalusCheck = document.getElementById(
            `${prefix}_changementAbsorptionCheck`
          ).checked;
          if (bonusMalusCheck) {
            const bonusMalus =
              parseInt(
                document.getElementById(`${prefix}_changementAbsorption`)
                .value
              ) || 0;
            absorptionValue += bonusMalus;
          }

          const degats = Math.ceil((vitalite * absorptionValue) / 100);
          document.getElementById(`${prefix}_degats`).value = degats;
        }
      };

      // Écouter les changements d'absorption
      const absorption = document.getElementById(`${prefix}_absorption`);
      absorption.addEventListener("input", updateDegats);

      // Écouter les changements de bonus/malus d'absorption
      const bonusMalusAbsorption = document.getElementById(
        `${prefix}_changementAbsorption`
      );
      bonusMalusAbsorption.addEventListener("input", updateDegats);

      // Mise à jour initiale
      updateDegats();
    }

    function toggleChangementAbsorption(prefix) {
      const bloc = document.getElementById(
        `${prefix}_changementAbsorptionBloc`
      );
      const isChecked = document.getElementById(
        `${prefix}_changementAbsorptionCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";

      // Recalculer les dégâts quand on active/désactive le bonus/malus
      if (document.getElementById(`${prefix}_corrompu`).checked) {
        const vitalite =
          parseInt(document.getElementById(`${prefix}_vitalite`).value) || 0;
        let absorptionValue =
          parseInt(document.getElementById(`${prefix}_absorption`).value) ||
          0;

        if (isChecked) {
          const bonusMalus =
            parseInt(
              document.getElementById(`${prefix}_changementAbsorption`).value
            ) || 0;
          absorptionValue += bonusMalus;
        }

        const degats = Math.ceil((vitalite * absorptionValue) / 100);
        document.getElementById(`${prefix}_degats`).value = degats;
      }
    }

    function toggleVitaliteDebut(prefix) {
      const bloc = document.getElementById(`${prefix}_vitaliteDebutBloc`);
      const isChecked = document.getElementById(
        `${prefix}_vitaliteDebutCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";

      // S'assurer que l'input n'est pas undefined quand on active la case
      if (isChecked) {
        const input = document.getElementById(`${prefix}_vitesseDebut`);
        if (!input.value || input.value === "undefined") {
          input.value = "";
        }
      }
      updateVitaliteDebut(prefix);
    }

    function updateVitaliteDebut(prefix) {
      const vitaliteBase =
        parseInt(document.getElementById(`${prefix}_vitalite`).value) || 0;
      const vitaliteDebutCheck = document.getElementById(
        `${prefix}_vitaliteDebutCheck`
      );

      if (vitaliteDebutCheck && vitaliteDebutCheck.checked) {
        const valeurComplete = document.getElementById(
          `${prefix}_vitaliteDebut`
        ).value;
        const valeurs = valeurComplete
          .split(" ")
          .filter((val) => val.trim() !== "");

        let totalBonus = 0;
        valeurs.forEach((valeur) => {
          valeur = valeur.trim();
          if (valeur.endsWith("%")) {
            const percentage = parseInt(valeur.slice(0, -1)) || 0;
            totalBonus += Math.ceil((vitaliteBase * percentage) / 100);
          } else {
            const value = parseInt(valeur) || 0;
            totalBonus += value;
          }
        });

        return vitaliteBase + totalBonus;
      }

      return vitaliteBase;
    }

    function toggleChangementVie(prefix) {
      const bloc = document.getElementById(`${prefix}_changementVieBloc`);
      const isChecked = document.getElementById(
        `${prefix}_changementVieCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleAura(prefix) {
      const bloc = document.getElementById(`${prefix}_auraBloc`);
      const isChecked = document.getElementById(
        `${prefix}_auraCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleVitesseDebut(prefix) {
      const bloc = document.getElementById(`${prefix}_vitesseDebutBloc`);
      const isChecked = document.getElementById(
        `${prefix}_vitesseDebutCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";

      // S'assurer que l'input n'est pas undefined quand on active la case
      if (isChecked) {
        const input = document.getElementById(`${prefix}_vitesseDebut`);
        if (!input.value || input.value === "undefined") {
          input.value = "";
        }
      }
      updateVitesseDebut(prefix);
    }

    function updateVitesseDebut(prefix) {
      const vitesseBase = parseInt(document.getElementById(`${prefix}_vitesse`).value) || 0;
      const vitesseDebutCheck = document.getElementById(`${prefix}_vitesseDebutCheck`);

      if (vitesseDebutCheck && vitesseDebutCheck.checked) {
        const valeurComplete = document.getElementById(`${prefix}_vitesseDebut`).value;
        const valeurs = valeurComplete.split(" ").filter(val => val.trim() !== "");

        let totalBonus = 0;
        valeurs.forEach(valeur => {
          valeur = valeur.trim();
          if (valeur.endsWith('%')) {
            const percentage = parseInt(valeur.slice(0, -1)) || 0;
            totalBonus += Math.floor((vitesseBase * percentage) / 100);
          } else {
            const value = parseInt(valeur) || 0;
            totalBonus += value;
          }
        });

        return vitesseBase + totalBonus;
      }

      return vitesseBase;
    }

    function toggleChangementVitesse(prefix) {
      const bloc = document.getElementById(`${prefix}_changementVitesseBloc`);
      const isChecked = document.getElementById(
        `${prefix}_changementVitesseCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleChangementDegats(prefix) {
      const bloc = document.getElementById(`${prefix}_changementDegatsBloc`);
      const isChecked = document.getElementById(
        `${prefix}_changementDegatsCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleChangementVieCompanion(prefix, idx) {
      const bloc = document.getElementById(
        `${prefix}_comp${idx}_changementVieBloc`
      );
      const isChecked = document.getElementById(
        `${prefix}_comp${idx}_changementVieCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleAuraCompanion(prefix, idx) {
      const bloc = document.getElementById(`${prefix}_comp${idx}_auraBloc`);
      const isChecked = document.getElementById(
        `${prefix}_comp${idx}_auraCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleChangementVitesseCompanion(prefix, idx) {
      const bloc = document.getElementById(
        `${prefix}_comp${idx}_changementVitesseBloc`
      );
      const isChecked = document.getElementById(
        `${prefix}_comp${idx}_changementVitesseCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function toggleChangementDegatsCompanion(prefix, idx) {
      const bloc = document.getElementById(
        `${prefix}_comp${idx}_changementDegatsBloc`
      );
      const isChecked = document.getElementById(
        `${prefix}_comp${idx}_changementDegatsCheck`
      ).checked;
      bloc.style.display = isChecked ? "block" : "none";
    }

    function collecterPersonnage(prefix) {
      const personnage = {
        nom: document.getElementById(`${prefix}_nom`).value,
        race: document.getElementById(`${prefix}_classe`).value,
        vitalite: document.getElementById(`${prefix}_vitalite`).value,
        invisible: document.getElementById(`${prefix}_invisible`).checked,
        auraCheck: document.getElementById(`${prefix}_auraCheck`).checked,
        aura: document.getElementById(`${prefix}_aura`).value,
        vitesse: document.getElementById(`${prefix}_vitesse`).value,
        degats: document.getElementById(`${prefix}_degats`).value,
        corrompu: document.getElementById(`${prefix}_corrompu`).checked,
        absorption: document.getElementById(`${prefix}_absorption`).value,
        changementAbsorptionCheck: document.getElementById(
          `${prefix}_changementAbsorptionCheck`
        )?.checked,
        changementAbsorption: document.getElementById(
          `${prefix}_changementAbsorption`
        )?.value,
        capacites: collecterCapacites(prefix),
        invocations: collecterInvocations(prefix),
      };
      return personnage;
    }

    function collecterCapacites(prefix) {
      const capacites = [];
      const titres = document.getElementsByClassName(
        `${prefix}_titreCapacite`
      );
      const descs = document.getElementsByClassName(
        `${prefix}_descriptionCapacite`
      );
      const classes = document.getElementsByClassName(
        `${prefix}_classeCapacite`
      );

      for (let i = 0; i < titres.length; i++) {
        const isNumberedCapacity = titres[i].value.startsWith("Capacité ");
        const titre = isNumberedCapacity ?
          titres[i].value :
          `x ${titres[i].value}`;

        capacites.push({
          titre: titre,
          description: descs[i].value,
          etat: classes[i].value,
        });
      }
      return capacites;
    }

    function collecterInvocations(prefix) {
      const invocations = [];
      const noms = document.querySelectorAll(`.${prefix}_comp_nom`);

      noms.forEach((_, idx) => {
        const invocation = {
          // Garder uniquement les données de base dans le JSON
          nom: document.querySelectorAll(`.${prefix}_comp_nom`)[idx].value,
          race: document.querySelectorAll(`.${prefix}_comp_race`)[idx].value,
          vitalite: document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx]
            .value,
          auraCheck: document.getElementById(`${prefix}_comp${idx}_auraCheck`)
            ?.checked || false,
          aura: document.getElementById(`${prefix}_comp${idx}_aura`)?.value ||
            "0",
          vitesse: document.querySelectorAll(`.${prefix}_comp_vitesse`)[idx]
            .value,
          degats: document.querySelectorAll(`.${prefix}_comp_degats`)[idx]
            .value,
          capacites: collecterCapacitesInvocation(prefix, idx),
        };

        // Stocker les données temporaires séparément du JSON
        (invocation._tempData = {
          changementVieCheck: document.getElementById(
            `${prefix}_comp${idx}_changementVieCheck`
          )?.checked,
          changementVie: document.getElementById(
            `${prefix}_comp${idx}_changementVie`
          )?.value,
          changementVitesseCheck: document.getElementById(
            `${prefix}_comp${idx}_changementVitesseCheck`
          )?.checked,
          changementVitesse: document.getElementById(
            `${prefix}_comp${idx}_changementVitesse`
          )?.value,
          changementDegatsCheck: document.getElementById(
            `${prefix}_comp${idx}_changementDegatsCheck`
          )?.checked,
          changementDegats: document.getElementById(
            `${prefix}_comp${idx}_changementDegats`
          )?.value,
        }),
        invocations.push(invocation);
      });

      // Ne retourner que les données de base, sans _tempData
      return invocations.map(({
        _tempData,
        ...rest
      }) => rest);
    }

    function collecterCapacitesInvocation(prefix, idx) {
      const capacites = [];
      const titres = document.querySelectorAll(
        `.${prefix}_comp${idx}_titreCapacite`
      );
      const descs = document.querySelectorAll(
        `.${prefix}_comp${idx}_descriptionCapacite`
      );
      const classes = document.querySelectorAll(
        `.${prefix}_comp${idx}_classeCapacite`
      );

      for (let i = 0; i < titres.length; i++) {
        const isNumberedCapacity = titres[i].value.startsWith("Capacité ");
        const titre = isNumberedCapacity ?
          titres[i].value :
          `x ${titres[i].value}`;

        capacites.push({
          titre: titre,
          titre: titres[i].value,
          description: descs[i].value,
          etat: classes[i].value,
        });
      }
      return capacites;
    }

    function exporterPersonnage(prefix) {
      const personnage = collecterPersonnage(prefix);
      const nom = personnage.nom || "personnage";
      const blob = new Blob([JSON.stringify(personnage, null, 2)], {
        type: "application/json",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `${nom}.json`;
      a.click();
    }

    function importerPersonnage(event, prefix) {
      const fichier = event.target.files[0];
      if (!fichier) return;

      // Vider tous les champs avant l'importation
      viderPersonnage(prefix);

      const reader = new FileReader();
      reader.onload = function(e) {
        const personnage = JSON.parse(e.target.result);
        remplirPersonnage(prefix, personnage);
      };
      reader.readAsText(fichier);
    }

    function viderPersonnage(prefix) {
      // Vider les champs principaux
      document.getElementById(`${prefix}_nom`).value = "";
      document.getElementById(`${prefix}_classe`).value = "humain"; // Valeur par défaut
      document.getElementById(`${prefix}_vitalite`).value = "";
      document.getElementById(`${prefix}_invisible`).checked = false;
      document.getElementById(`${prefix}_auraCheck`).checked = false;
      document.getElementById(`${prefix}_aura`).value = "0";
      document.getElementById(`${prefix}_auraBloc`).style.display = "none";
      document.getElementById(`${prefix}_vitesse`).value = "";
      document.getElementById(`${prefix}_degats`).value = "";

      // Réinitialiser les checkboxes et leurs blocs associés
      document.getElementById(`${prefix}_changementVieCheck`).checked = false;
      document.getElementById(
        `${prefix}_changementVitesseCheck`
      ).checked = false;
      document.getElementById(
        `${prefix}_changementDegatsCheck`
      ).checked = false;
      document.getElementById(`${prefix}_corrompu`).checked = false;

      // Vider et cacher les blocs de bonus/malus
      document.getElementById(`${prefix}_changementVie`).value = "";
      document.getElementById(`${prefix}_changementVitesse`).value = "";
      document.getElementById(`${prefix}_changementDegats`).value = "";
      document.getElementById(`${prefix}_absorption`).value = "0";

      document.getElementById(`${prefix}_changementVieBloc`).style.display =
        "none";
      document.getElementById(
        `${prefix}_changementVitesseBloc`
      ).style.display = "none";
      document.getElementById(
        `${prefix}_changementDegatsBloc`
      ).style.display = "none";
      document.getElementById(`${prefix}_absorptionBloc`).style.display =
        "none";

      // Vider les capacités
      document.getElementById(`${prefix}_capacites_input`).value = "";
      document.getElementById(`${prefix}_capacites`).innerHTML = "";

      // Réinitialiser les invocations
      document.getElementById(`${prefix}_nbCompagnons`).value = "0";
      document.getElementById(`${prefix}_compagnons`).innerHTML = "";
    }

    function remplirPersonnage(prefix, data) {
      // Remplir les champs de base
      document.getElementById(`${prefix}_nom`).value = data.nom;
      updateCharacterName(prefix);
      document.getElementById(`${prefix}_classe`).value = data.race;
      document.getElementById(`${prefix}_vitalite`).value = data.vitalite;
      document.getElementById(`${prefix}_vitaliteDebutCheck`).checked =
        data.vitaliteDebutCheck;
      document.getElementById(`${prefix}_vitaliteDebut`).value =
        data.vitaliteDebut;
      document.getElementById(`${prefix}_changementVieCheck`).checked =
        data.changementVie;
      document.getElementById(`${prefix}_invisible`).checked = data.invisible;
      document.getElementById(`${prefix}_vitesse`).value = data.vitesse;
      document.getElementById(`${prefix}_vitesseDebutCheck`).checked =
        data.vitesseDebutCheck;
      document.getElementById(`${prefix}_vitesseDebut`).value =
        data.vitesseDebut;
      document.getElementById(`${prefix}_changementVitesseCheck`).checked =
        data.changementVitesse;
      document.getElementById(`${prefix}_degats`).value = data.degats;
      document.getElementById(`${prefix}_changementDegatsCheck`).checked =
        data.changementDegats;
      document.getElementById(`${prefix}_corrompu`).checked = data.corrompu;

      // Gérer l'absorption si corrompu
      if (data.corrompu) {
        document.getElementById(`${prefix}_absorption`).value =
          data.absorption;
        document.getElementById(
          `${prefix}_changementAbsorptionCheck`
        ).checked = data.changementAbsorptionCheck;
        if (data.changementAbsorptionCheck) {
          document.getElementById(`${prefix}_changementAbsorption`).value =
            data.changementAbsorption;
          toggleChangementAbsorption(prefix);
        }
        toggleAbsorption(prefix); // Assurez-vous que le bloc d'absorption est visible
      }

      // Restaurer la vitalité de début
      if (data.vitaliteDebutCheck) {
        document.getElementById(
          `${prefix}_vitaliteDebutCheck`
        ).checked = true;
        document.getElementById(`${prefix}_vitaliteDebut`).value =
          data.vitaliteDebut;
        toggleVitaliteDebut(prefix);
      }

      // Gérer les malus/bonus de Vie si activé
      if (data.changementVie) {
        document.getElementById(`${prefix}_changementVie`).value =
          data.changementVie;
        toggleChangementVie(prefix); // Assurez-vous que le bloc de Malus/Bonus Vie est visible
      }

      // Gérer l'aura si case coché
      if (data.auraCheck) {
        document.getElementById(`${prefix}_auraCheck`).checked = true;
        document.getElementById(`${prefix}_aura`).value = data.aura;
        toggleAura(prefix);
      }

      // Restaurer la vitesse de début
      if (data.vitesseDebutCheck) {
        document.getElementById(
          `${prefix}_vitesseDebutCheck`
        ).checked = true;
        document.getElementById(`${prefix}_vitesseDebut`).value =
          data.vitesseDebut;
        toggleVitesseDebut(prefix);
      }

      // Gérer les malus/bonus de Vitesse si activé
      if (data.changementVitesse) {
        document.getElementById(`${prefix}_changementVitesse`).value =
          data.changementVitesse;
        toggleChangementVitesse(prefix); // Assurez-vous que le bloc de Malus/Bonus Vitesse est visible
      }

      // Gérer les malus/bonus de Degats si activé
      if (data.changementDegats) {
        document.getElementById(`${prefix}_changementDegats`).value =
          data.changementDegats;
        toggleChangementDegats(prefix); // Assurez-vous que le bloc de Malus/Bonus Degats est visible
      }

      // Remplir les capacités
      const capacitesTexte = data.capacites
        .map((c) => {
          if (c.titre.startsWith("Capacité ") || c.titre.startsWith("x ")) {
            return `${c.titre} : ${c.description}`;
          }
          return `x ${c.titre} : ${c.description}`;
        })
        .join("\n");
      document.getElementById(`${prefix}_capacites_input`).value =
        capacitesTexte;
      parseCapacites(prefix);

      // Mettre à jour les états des capacités
      const classes = document.getElementsByClassName(
        `${prefix}_classeCapacite`
      );
      data.capacites.forEach((c, i) => {
        if (classes[i]) classes[i].value = c.etat;
      });

      // Gérer les invocations
      if (data.invocations && data.invocations.length > 0) {
        document.getElementById(`${prefix}_nbCompagnons`).value =
          data.invocations.length;
        updateCompanions(prefix);
        data.invocations.forEach((inv, idx) => {
          remplirInvocation(prefix, idx, inv);
          updateCompanionName(prefix, idx);
        });
      }
    }

    function remplirInvocation(prefix, idx, data) {
      const inputs = {
        nom: document.querySelectorAll(`.${prefix}_comp_nom`)[idx],
        race: document.querySelectorAll(`.${prefix}_comp_race`)[idx],
        vitalite: document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx],
        vitesse: document.querySelectorAll(`.${prefix}_comp_vitesse`)[idx],
        degats: document.querySelectorAll(`.${prefix}_comp_degats`)[idx],
      };

      if (data.auraCheck) {
        document.getElementById(
          `${prefix}_comp${idx}_auraCheck`
        ).checked = true;
        document.getElementById(`${prefix}_comp${idx}_aura`).value =
          data.aura;
        toggleAuraCompanion(prefix, idx);
      }

      // Vérifier que tous les éléments existent avant de les remplir
      if (Object.values(inputs).every((el) => el)) {
        Object.entries(inputs).forEach(([key, el]) => {
          el.value = data[key];
          // Mettre à jour le titre après avoir rempli le nom
          if (key === "nom") {
            updateCompanionName(prefix, idx);
          }
        });

        // Mettre à jour le titre avec le nom de l'invocation
        if (data.nom) {
          const title = document.getElementById(`${prefix}_comp${idx}_title`);
          if (title) {
            title.textContent = data.nom;
          }
        }

        // Restaurer les données temporaires si elles existent
        if (data._tempData) {
          // Restaurer la vitalité de début
          if (data._tempData.vitaliteDebutCheck) {
            document.getElementById(`${prefix}_vitaliteDebutCheck`).checked =
              data._tempData.vitaliteDebutCheck;
            document.getElementById(`${prefix}_vitaliteDebut`).value =
              data._tempData.vitaliteDebut;
            toggleVitaliteDebut(prefix);
          }
          // Bonus/Malus Vie
          const changementVieCheck = document.getElementById(
            `${prefix}_comp${idx}_changementVieCheck`
          );
          if (changementVieCheck) {
            changementVieCheck.checked = data._tempData.changementVieCheck;
            if (data._tempData.changementVieCheck) {
              toggleChangementVieCompanion(prefix, idx);
              document.getElementById(
                `${prefix}_comp${idx}_changementVie`
              ).value = data._tempData.changementVie;
            }
          }
          if (data._tempData.vitesseDebutCheck) {
            document.getElementById(`${prefix}_vitesseDebutCheck`).checked =
              data._tempData.vitesseDebutCheck;
            document.getElementById(`${prefix}_vitesseDebut`).value =
              data._tempData.vitesseDebut;
            toggleVitesseDebut(prefix);
          }
          // Bonus/Malus Vitesse
          const changementVitesseCheck = document.getElementById(
            `${prefix}_comp${idx}_changementVitesseCheck`
          );
          if (changementVitesseCheck) {
            changementVitesseCheck.checked =
              data._tempData.changementVitesseCheck;
            if (data._tempData.changementVitesseCheck) {
              toggleChangementVitesseCompanion(prefix, idx);
              document.getElementById(
                `${prefix}_comp${idx}_changementVitesse`
              ).value = data._tempData.changementVitesse;
            }
          }

          // Bonus/Malus Dégâts
          const changementDegatsCheck = document.getElementById(
            `${prefix}_comp${idx}_changementDegatsCheck`
          );
          if (changementDegatsCheck) {
            changementDegatsCheck.checked =
              data._tempData.changementDegatsCheck;
            if (data._tempData.changementDegatsCheck) {
              toggleChangementDegatsCompanion(prefix, idx);
              document.getElementById(
                `${prefix}_comp${idx}_changementDegats`
              ).value = data._tempData.changementDegats;
            }
          }
        }

        // Remplir les capacités de l'invocation
        const capacitesTexte = data.capacites
          .map((c) => {
            if (c.titre.startsWith("Capacité ") || c.titre.startsWith("x ")) {
              return `${c.titre} : ${c.description}`;
            }
            return `x ${c.titre} : ${c.description}`;
          })
          .join("\n");
        const inputCapacites = document.getElementById(
          `${prefix}_comp${idx}_capacites_input`
        );
        if (inputCapacites) {
          inputCapacites.value = capacitesTexte;
          parseCapacitesInvocations(prefix, idx);

          // Mettre à jour les états des capacités
          const classes = document.querySelectorAll(
            `.${prefix}_comp${idx}_classeCapacite`
          );
          data.capacites.forEach((c, i) => {
            if (classes[i]) classes[i].value = c.etat;
          });
        }
      }
    }

    // Pour les boutons de Groupe (CSS)
    function switchTab(group) {
      const tabs = document.querySelectorAll(".tab-button");
      tabs.forEach((tab) => tab.classList.remove("active"));

      const forms = document.querySelectorAll("#combat-form > div");
      forms.forEach((div) => div.classList.remove("active"));

      document
        .querySelector(`.tab-button[onclick*="${group}"]`)
        .classList.add("active");
      document.getElementById(`${group}-form`).classList.add("active");
    }

    // Pour les boutons de personnage (CSS)
    function toggleCharacter(idPrefix) {
      const bloc = document.getElementById(idPrefix).closest(".bloc");
      bloc.classList.toggle("expanded");
    }

    // Changement de Personnage 1 en Nom du personnage
    function updateCharacterName(prefix) {
      const newName =
        document.getElementById(`${prefix}_nom`).value ||
        `Personnage ${prefix.split("_")[1].substring(1)}`;
      const h3 = document.querySelector(`#${prefix} h3`);
      if (h3) {
        h3.textContent = newName;
      }
    }

    function updateCompanionName(prefix, idx) {
      const compNom = document.querySelectorAll(`.${prefix}_comp_nom`)[idx];
      const title = document.getElementById(`${prefix}_comp${idx}_title`);
      if (compNom && title) {
        title.textContent = compNom.value || `Invocation ${idx + 1}`;
      }
    }

    window.onload = function() {
      genererFormulairesGroupes();
      document.getElementById("groupe1-form").classList.add("active");
      // Déplier le personnage 1 du groupe 1
      const blocG1 = document.getElementById("g1_p0");
      if (blocG1) blocG1.classList.add("expanded");

      // Déplier le personnage 1 du groupe 2
      const blocG2 = document.getElementById("g2_p0");
      if (blocG2) blocG2.classList.add("expanded");
      window.onload = function() {
        genererFormulairesGroupes();
      };
    };
  </script>
</body>

</html>