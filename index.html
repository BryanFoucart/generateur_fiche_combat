<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Générateur de Combat</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }

      label {
        display: block;
        margin-top: 10px;
      }

      .bloc {
        border: 1px solid #ccc;
        padding: 15px;
        margin-top: 20px;
      }

      .capacite-container {
        margin-left: 20px;
        margin-bottom: 10px;
      }

      .companion-container {
        border: 1px dashed #aaa;
        padding: 10px;
        margin-top: 10px;
      }

      textarea {
        width: 100%;
        height: 300px;
      }
    </style>
  </head>

  <body>
    <h2>Générateur de Fiche de Combat</h2>

    <div>
      <label
        >Nombre de personnages dans le Groupe 1 :
        <input
          type="number"
          id="nbGroupe1"
          value="1"
          min="1"
          onchange="genererGroupe(1)"
        />
      </label>
      <label
        >Nombre de personnages dans le Groupe 2 :
        <input
          type="number"
          id="nbGroupe2"
          value="1"
          min="1"
          onchange="genererGroupe(2)"
        />
      </label>
    </div>

    <div id="combat-form">
      <div id="groupe1-form"></div>
      <div id="groupe2-form"></div>
    </div>

    <button onclick="genererHTML()">Générer le Code HTML</button>

    <h2>Résultat HTML :</h2>
    <textarea id="resultat" readonly></textarea>

    <script>
      function genererGroupe(groupeNum) {
        const nb = parseInt(
          document.getElementById(`nbGroupe${groupeNum}`).value
        );

        // Sauvegarder les données existantes pour chaque personnage du groupe
        const savedCharacters = [];
        for (
          let i = 0;
          i <
          document.querySelectorAll(`#groupe${groupeNum}-form .bloc`).length;
          i++
        ) {
          const prefix = `g${groupeNum}_p${i}`;
          const personnage = collecterPersonnage(prefix); // Utilise la fonction existante
          personnage._tempData = {
            changementVieCheck: document.getElementById(
              `${prefix}_changementVieCheck`
            )?.checked,
            changementVie: document.getElementById(`${prefix}_changementVie`)
              ?.value,
            changementVitesseCheck: document.getElementById(
              `${prefix}_changementVitesseCheck`
            )?.checked,
            changementVitesse: document.getElementById(
              `${prefix}_changementVitesse`
            )?.value,
            changementDegatsCheck: document.getElementById(
              `${prefix}_changementDegatsCheck`
            )?.checked,
            changementDegats: document.getElementById(
              `${prefix}_changementDegats`
            )?.value,
          };
          // Sauvegarder les données temporaires des invocations
          personnage._invocationsTemp = [];
          const compagnons = document.querySelectorAll(`.${prefix}_comp_nom`);
          compagnons.forEach((_, idx) => {
            personnage._invocationsTemp.push({
              changementVieCheck: document.getElementById(
                `${prefix}_comp${idx}_changementVieCheck`
              )?.checked,
              changementVie: document.getElementById(
                `${prefix}_comp${idx}_changementVie`
              )?.value,
              changementVitesseCheck: document.getElementById(
                `${prefix}_comp${idx}_changementVitesseCheck`
              )?.checked,
              changementVitesse: document.getElementById(
                `${prefix}_comp${idx}_changementVitesse`
              )?.value,
              changementDegatsCheck: document.getElementById(
                `${prefix}_comp${idx}_changementDegatsCheck`
              )?.checked,
              changementDegats: document.getElementById(
                `${prefix}_comp${idx}_changementDegats`
              )?.value,
            });
          });

          savedCharacters.push(personnage);
        }

        // Générer le nouveau HTML pour ce groupe
        let html = `<h3>Groupe ${groupeNum}</h3>`;
        for (let i = 0; i < nb; i++) {
          html += createCharacterForm(
            `g${groupeNum}_p${i}`,
            `Personnage ${i + 1}`
          );
        }
        document.getElementById(`groupe${groupeNum}-form`).innerHTML = html;

        // Restaurer les données pour chaque personnage
        savedCharacters.forEach((personnage, i) => {
          if (i < nb) {
            // Ne restaurer que si le personnage existe toujours
            const prefix = `g${groupeNum}_p${i}`;
            remplirPersonnage(prefix, personnage); // Utilise la fonction existante
            if (personnage._tempData) {
              document.getElementById(`${prefix}_changementVieCheck`).checked =
                personnage._tempData.changementVieCheck;
              document.getElementById(`${prefix}_changementVie`).value =
                personnage._tempData.changementVie;
              document.getElementById(
                `${prefix}_changementVitesseCheck`
              ).checked = personnage._tempData.changementVitesseCheck;
              document.getElementById(`${prefix}_changementVitesse`).value =
                personnage._tempData.changementVitesse;
              document.getElementById(
                `${prefix}_changementDegatsCheck`
              ).checked = personnage._tempData.changementDegatsCheck;
              document.getElementById(`${prefix}_changementDegats`).value =
                personnage._tempData.changementDegats;
              if (personnage._tempData.changementVieCheck) {
                toggleChangementVie(prefix);
              }
              if (personnage._tempData.changementVitesseCheck) {
                toggleChangementVitesse(prefix);
              }
              if (personnage._tempData.changementDegatsCheck) {
                toggleChangementDegats(prefix);
              }
            }

            // Restaurer les données temporaires des invocations
            if (personnage._invocationsTemp) {
              document.getElementById(`${prefix}_nbCompagnons`).value =
                personnage._invocationsTemp.length;
              updateCompanions(prefix);
              personnage._invocationsTemp.forEach((invocTemp, idx) => {
                const changementVieCheck = document.getElementById(
                  `${prefix}_comp${idx}_changementVieCheck`
                );
                if (changementVieCheck) {
                  changementVieCheck.checked = invocTemp.changementVieCheck;
                  if (invocTemp.changementVieCheck) {
                    toggleChangementVieCompanion(prefix, idx);
                    document.getElementById(
                      `${prefix}_comp${idx}_changementVie`
                    ).value = invocTemp.changementVie;
                  }
                }

                const changementVitesseCheck = document.getElementById(
                  `${prefix}_comp${idx}_changementVitesseCheck`
                );
                if (changementVitesseCheck) {
                  changementVitesseCheck.checked =
                    invocTemp.changementVitesseCheck;
                  if (invocTemp.changementVitesseCheck) {
                    toggleChangementVitesseCompanion(prefix, idx);
                    document.getElementById(
                      `${prefix}_comp${idx}_changementVitesse`
                    ).value = invocTemp.changementVitesse;
                  }
                }

                const changementDegatsCheck = document.getElementById(
                  `${prefix}_comp${idx}_changementDegatsCheck`
                );
                if (changementDegatsCheck) {
                  changementDegatsCheck.checked =
                    invocTemp.changementDegatsCheck;
                  if (invocTemp.changementDegatsCheck) {
                    toggleChangementDegatsCompanion(prefix, idx);
                    document.getElementById(
                      `${prefix}_comp${idx}_changementDegats`
                    ).value = invocTemp.changementDegats;
                  }
                }
              });
            }
          }
        });
      }

      function genererFormulairesGroupes() {
        const nb1 = parseInt(document.getElementById("nbGroupe1").value);
        const nb2 = parseInt(document.getElementById("nbGroupe2").value);

        // 1. Sauvegarder les données existantes
        const existingData = {};
        const inputs = document.querySelectorAll(
          "#combat-form input, #combat-form select, #combat-form textarea"
        );
        inputs.forEach((input) => {
          if (input.id) {
            existingData[input.id] =
              input.type === "checkbox" ? input.checked : input.value;
          }
        });

        // 2. Générer le HTML pour chaque groupe
        let html1 = `<h3>Groupe 1</h3>`;
        for (let i = 0; i < nb1; i++) {
          html1 += createCharacterForm(`g1_p${i}`, `Personnage ${i + 1}`);
        }
        document.getElementById("groupe1-form").innerHTML = html1;

        let html2 = `<h3>Groupe 2</h3>`;
        for (let i = 0; i < nb2; i++) {
          html2 += createCharacterForm(`g2_p${i}`, `Personnage ${i + 1}`);
        }
        document.getElementById("groupe2-form").innerHTML = html2;

        // 3. Restaurer les données
        for (const id in existingData) {
          const el = document.getElementById(id);
          if (el) {
            if (el.type === "checkbox") {
              el.checked = existingData[id];
              if (el.onchange) el.onchange();
            } else {
              el.value = existingData[id];
              if (el.oninput) el.oninput();
            }
          }
        }
      }

      function createCharacterForm(idPrefix, label) {
        return `
                  <div class="bloc">
                  <h3>${label}</h3>
                  <label>Nom :
                  <input type="text" id="${idPrefix}_nom">
                  </label>
                  <label>Race :
                  <select id="${idPrefix}_classe">
                  <option value="abyssal">Abyssal</option>
                  <option value="djöllfulin">Djöllfulin</option>
                  <option value="elfe">Elfe</option>
                  <option value="entomothrope">Entomothrope</option>
                  <option value="géant">Géant</option>
                  <option value="humain">Humain</option>
                  <option value="hybride">Hybride</option>
                  <option value="naga">Naga</option>
                  <option value="nain">Nain</option>
                  <option value="orc">Orc</option>
                  <option value="stryge-blanc">Stryge Blanc</option>
                  <option value="stryge-noir">Stryge Noir</option>
                  <option value="thérianthrope">Thérianthrope</option>
                  <option value="vampire">Vampire</option>
                  <option value="bestiaire-nom">Créature</option>
                  <option value="boss">Boss</option>
                  <option value="archi-boss">Archi-Boss</option>
                  </select>
                  </label>

                  <label>Vitalité :
                  <input type="number" id="${idPrefix}_vitalite">
                  </label>
                  <label>
                  <input type="checkbox" id="${idPrefix}_changementVieCheck" onchange="toggleChangementVie('${idPrefix}')"> Bonus/Malus ?
                  </label>
                  <div id="${idPrefix}_changementVieBloc" style="display: none;">
                  <label>Bonus/Malus :
                  <input type="text" id="${idPrefix}_changementVie">
                  </label>
                  </div>
                  <label>Vitesse :
                  <input type="number" id="${idPrefix}_vitesse">
                  </label>
                  <label>
                  <input type="checkbox" id="${idPrefix}_changementVitesseCheck" onchange="toggleChangementVitesse('${idPrefix}')"> Bonus/Malus ?
                  </label>
                  <div id="${idPrefix}_changementVitesseBloc" style="display: none;">
                  <label>Bonus/Malus :
                  <input type="text" id="${idPrefix}_changementVitesse">
                  </label>
                  </div>
                  <label>
                  <input type="checkbox" id="${idPrefix}_corrompu" onchange="toggleAbsorption('${idPrefix}')"> Corrompu ?
                  </label>
                  <div id="${idPrefix}_absorptionBloc" style="display: none;">
                  <label>Absorption (%) :
                  <input type="number" id="${idPrefix}_absorption" value="0">
                  </label>
                  </div>
                  <label>Dégâts :
                  <input type="number" id="${idPrefix}_degats">
                  </label>
                  <label>
                  <input type="checkbox" id="${idPrefix}_changementDegatsCheck" onchange="toggleChangementDegats('${idPrefix}')"> Bonus/Malus ?
                  </label>
                  <div id="${idPrefix}_changementDegatsBloc" style="display: none;">
                  <label>Bonus/Malus :
                  <input type="text" id="${idPrefix}_changementDegats">
                  </label>
                  </div>

                  <label>Capacités spéciales (format : "x Titre : Description", un x en début de chaque compétence) :
                  <textarea id="${idPrefix}_capacites_input" oninput="parseCapacites('${idPrefix}')" placeholder="EXEMPLE
                  x Rapidité : permet d'attaquer à deux reprises.
                  x Hydro cyno : Régénère la vitalité lorsqu'elle atteint 25%.
                  x Attache ensablée : À chaque attache réussie, la cible s'affaiblit et réduit les dégâts de sa prochaine attaque à hauteur de 10% des dégâts du corrompu. Non réalisable dans la région des 'Mers & Océans'."></textarea>
                  </label>
                  <div id="${idPrefix}_capacites"></div>

                  <label>Nombre d'invocations :
                  <input type="number" id="${idPrefix}_nbCompagnons" value="0" min="0" onchange="updateCompanions('${idPrefix}')">
                  </label>
                  <div id="${idPrefix}_compagnons"></div>

                  <div class="character-actions">
                  <button onclick="exporterPersonnage('${idPrefix}')">Exporter ce personnage</button>
                  <input type="file" id="${idPrefix}_import" accept=".json" onchange="importerPersonnage(event, '${idPrefix}')" style="display: none;">
                  <button onclick="document.getElementById('${idPrefix}_import').click()">Importer un personnage</button>
                  </div>
                  </div>
                  `;
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // function parseCapacites(prefix) {
      //   const input = document.getElementById(
      //     `${prefix}_capacites_input`
      //   ).value;
      //   const container = document.getElementById(`${prefix}_capacites`);
      //   container.innerHTML = ""; // Reset

      //   // Traiter les lignes une par une
      //   const lines = input.split("\n").filter((l) => l.trim() !== "");
      //   let currentLines = [];

      //   for (let i = 0; i < lines.length; i++) {
      //     if (lines[i].trim() === "@not") {
      //       if (currentLines.length > 0 && i + 1 < lines.length) {
      //         const lastLine = currentLines.pop();
      //         currentLines.push(lastLine + "\n" + lines[i + 1]);
      //         i++;
      //       }
      //     } else {
      //       currentLines.push(lines[i]);
      //     }
      //   }

      //   currentLines.forEach((line, index) => {
      //     // Nettoyer les éventuels @not restants
      //     const cleanLine = line
      //       .split("\n")
      //       .filter((l) => l.trim() !== "@not")
      //       .join("\n");

      //     const firstColonIndex = cleanLine.indexOf(":");

      //     // Continuer avec le traitement normal pour les lignes sans spoiler
      //     if (firstColonIndex !== -1) {
      //       const titre = cleanLine.substring(0, firstColonIndex).trim();
      //       const description = cleanLine.substring(firstColonIndex + 1).trim();
      //       const escapedTitre = escapeHtml(titre);
      //       const escapedDescription = escapeHtml(description);

      //       container.innerHTML += `
      // <div class="capacite-container">
      //   <input type="hidden" class="${prefix}_titreCapacite" value="${escapedTitre}">
      //   <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedDescription}">
      //   <p><strong><em>${escapedTitre}</em></strong> : ${escapedDescription}</p>
      //   <label>État :
      //     <select class="${prefix}_classeCapacite">
      //       <option value="capacité_spéciale">Neutre</option>
      //       <option value="capacité_spéciale active">Active</option>
      //       <option value="capacité_spéciale passive">Passive</option>
      //       <option value="capacité_spéciale bloquée">Bloquée</option>
      //       <option value="capacité_spéciale utilisée">Utilisée</option>
      //       <option value="capacité_spéciale annulée">Annulée</option>
      //       <option value="capacité_spéciale inactive">Inactive</option>
      //     </select>
      //   </label>
      // </div>`;
      //     } else {
      //       const escapedLine = escapeHtml(cleanLine);
      //       container.innerHTML += `
      // <div class="capacite-container">
      //    <input type="hidden" class="${prefix}_titreCapacite" value="Capacité ${
      //         index + 1
      //       }">
      //   <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedLine}">
      //   <p><strong><em>Capacité ${index + 1}</em></strong> : ${escapedLine}</p>
      //   <label>État :
      //     <select class="${prefix}_classeCapacite">
      //       <option value="capacité_spéciale">Neutre</option>
      //       <option value="capacité_spéciale active">Active</option>
      //       <option value="capacité_spéciale passive">Passive</option>
      //       <option value="capacité_spéciale bloquée">Bloquée</option>
      //       <option value="capacité_spéciale utilisée">Utilisée</option>
      //       <option value="capacité_spéciale annulée">Annulée</option>
      //       <option value="capacité_spéciale inactive">Inactive</option>
      //     </select>
      //   </label>
      // </div>`;
      //     }
      //   });
      // }

      function parseCapacites(prefix) {
        const input = document.getElementById(
          `${prefix}_capacites_input`
        ).value;
        const container = document.getElementById(`${prefix}_capacites`);
        container.innerHTML = ""; // Reset

        const lines = input
          .split("\n")
          .map((l) => l.trim())
          .filter((l) => l !== "");

        const entries = [];
        let currentLine = null;

        lines.forEach((line) => {
          if (line.startsWith("x ")) {
            // Nouvelle capacité
            if (currentLine !== null) {
              entries.push(currentLine);
            }
            currentLine = line.substring(2); // Retire le "x "
          } else if (currentLine !== null) {
            currentLine += "\n" + line; // Ajoute la ligne suivante à la description
          }
        });

        if (currentLine !== null) {
          entries.push(currentLine); // Ajouter la dernière
        }

        entries.forEach((entry, index) => {
          const firstColonIndex = entry.indexOf(":");

          if (firstColonIndex !== -1) {
            const titre = entry.substring(0, firstColonIndex).trim();
            const description = entry.substring(firstColonIndex + 1).trim();
            const escapedTitre = escapeHtml(titre);
            const escapedDescription = escapeHtml(description);

            container.innerHTML += `
                  <li>
                  <input type="hidden" class="${prefix}_titreCapacite" value="${escapedTitre}">
                  <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedDescription}">
                  <em>${escapedTitre}</em> : ${escapedDescription}
                  <br>
                  <label>État :
                  <select class="${prefix}_classeCapacite">
                  <option value="capacité_spéciale">Neutre</option>
                  <option value="capacité_spéciale active">Active</option>
                  <option value="capacité_spéciale passive">Passive</option>
                  <option value="capacité_spéciale bloquée">Bloquée</option>
                  <option value="capacité_spéciale utilisée">Utilisée</option>
                  <option value="capacité_spéciale annulée">Annulée</option>
                  <option value="capacité_spéciale inactive">Inactive</option>
                  </select>
                  </label>
                  </li>`;
          } else {
            const escapedLine = escapeHtml(entry);
            container.innerHTML += `
                  <li>
                  <input type="hidden" class="${prefix}_titreCapacite" value="Capacité ${
              index + 1
            }">
                  <input type="hidden" class="${prefix}_descriptionCapacite" value="${escapedLine}">
                  <em>Capacité ${index + 1}</em> : ${escapedLine}
                  <br>
                  <label>État :
                  <select class="${prefix}_classeCapacite">
                  <option value="capacité_spéciale">Neutre</option>
                  <option value="capacité_spéciale active">Active</option>
                  <option value="capacité_spéciale passive">Passive</option>
                  <option value="capacité_spéciale bloquée">Bloquée</option>
                  <option value="capacité_spéciale utilisée">Utilisée</option>
                  <option value="capacité_spéciale annulée">Annulée</option>
                  <option value="capacité_spéciale inactive">Inactive</option>
                  </select>
                  </label>
                  </li>`;
          }
        });
      }

      function updateCompanions(prefix) {
        const nb = parseInt(
          document.getElementById(`${prefix}_nbCompagnons`).value
        );
        const container = document.getElementById(`${prefix}_compagnons`);

        // Sauvegarder les données existantes des invocations
        const existingCompanions = [];
        const currentCompanions = container.getElementsByClassName(
          "companion-container"
        );
        Array.from(currentCompanions).forEach((comp, idx) => {
          const companion = {
            nom: comp.querySelector(`.${prefix}_comp_nom`)?.value || "",
            race: comp.querySelector(`.${prefix}_comp_race`)?.value || "",
            vitalite:
              comp.querySelector(`.${prefix}_comp_vitalite`)?.value || "",
            changementVieCheck:
              comp.querySelector(`#${prefix}_comp${idx}_changementVieCheck`)
                ?.checked || false,
            changementVie:
              comp.querySelector(`#${prefix}_comp${idx}_changementVie`)
                ?.value || "",
            vitesse: comp.querySelector(`.${prefix}_comp_vitesse`)?.value || "",
            changementVitesseCheck:
              comp.querySelector(`#${prefix}_comp${idx}_changementVitesseCheck`)
                ?.checked || false,
            changementVitesse:
              comp.querySelector(`#${prefix}_comp${idx}_changementVitesse`)
                ?.value || "",
            degats: comp.querySelector(`.${prefix}_comp_degats`)?.value || "",
            changementDegatsCheck:
              comp.querySelector(`#${prefix}_comp${idx}_changementDegatsCheck`)
                ?.checked || false,
            changementDegats:
              comp.querySelector(`#${prefix}_comp${idx}_changementDegats`)
                ?.value || "",
            capacites:
              comp.querySelector(`#${prefix}_comp${idx}_capacites_input`)
                ?.value || "",
          };
          existingCompanions.push(companion);
        });

        // Générer le nouveau HTML
        container.innerHTML = "";
        for (let i = 0; i < nb; i++) {
          container.innerHTML += `
                  <div class="companion-container">
                  <h4>Invocation ${i + 1}</h4>
                  <label>Nom :
                  <input type="text" class="${prefix}_comp_nom">
                  </label>
                  <label>Race :
                  <input type="text" class="${prefix}_comp_race" value="invocation" hidden>Invocation
                  </label>
                  <label>Vitalité :
                  <input type="number" class="${prefix}_comp_vitalite">
                  </label>
                  <label>
                  <input type="checkbox" id="${prefix}_comp${i}_changementVieCheck" onchange="toggleChangementVieCompanion('${prefix}', ${i})"> Bonus/Malus ?
                  </label>
                  <div id="${prefix}_comp${i}_changementVieBloc" style="display: none;">
                  <label>Bonus/Malus :
                  <input type="text" id="${prefix}_comp${i}_changementVie">
                  </label>
                  </div>
                  <label>Vitesse :
                  <input type="number" class="${prefix}_comp_vitesse">
                  </label>
                  <label>
                    <input type="checkbox" id="${prefix}_comp${i}_changementVitesseCheck" onchange="toggleChangementVitesseCompanion('${prefix}', ${i})"> Bonus/Malus ?
                </label>
                <div id="${prefix}_comp${i}_changementVitesseBloc" style="display: none;">
                    <label>Bonus/Malus :
                        <input type="text" id="${prefix}_comp${i}_changementVitesse">
                    </label>
                </div>
                  <label>Dégâts :
                  <input type="number" class="${prefix}_comp_degats">
                  </label>
                  <label>
                    <input type="checkbox" id="${prefix}_comp${i}_changementDegatsCheck" onchange="toggleChangementDegatsCompanion('${prefix}', ${i})"> Bonus/Malus ?
                </label>
                <div id="${prefix}_comp${i}_changementDegatsBloc" style="display: none;">
                    <label>Bonus/Malus :
                        <input type="text" id="${prefix}_comp${i}_changementDegats">
                    </label>
                </div>
                  <label>Capacités spéciales (format : "x Titre : Description", un x en début de chaque compétence) :
                  <textarea id="${prefix}_comp${i}_capacites_input" oninput="parseCapacitesInvocations('${prefix}', ${i})" placeholder="EXEMPLE
                  x Rapidité : permet d'attaquer à deux reprises.
                  x Hydro cyno : Régénère la vitalité lorsqu'elle atteint 25%.
                  x Attache ensablée : À chaque attache réussie, la cible s'affaiblit et réduit les dégâts de sa prochaine attaque à hauteur de 10% des dégâts du corrompu. Non réalisable dans la région des 'Mers & Océans'."></textarea>
                  </label>
                  <div id="${prefix}_comp${i}_capacites"></div>
                  </div>
                  `;
        }

        // Restaurer les données sauvegardées
        existingCompanions.forEach((comp, idx) => {
          if (idx < nb) {
            // Ne restaurer que si l'invocation existe toujours
            const newContainer = container.children[idx];
            if (newContainer) {
              newContainer.querySelector(`.${prefix}_comp_nom`).value =
                comp.nom;
              newContainer.querySelector(`.${prefix}_comp_race`).value =
                comp.race;
              newContainer.querySelector(`.${prefix}_comp_vitalite`).value =
                comp.vitalite;

              const changementVieCheck = newContainer.querySelector(
                `#${prefix}_comp${idx}_changementVieCheck`
              );
              if (changementVieCheck) {
                changementVieCheck.checked = comp.changementVieCheck;
                if (comp.changementVieCheck) {
                  toggleChangementVieCompanion(prefix, idx);
                  newContainer.querySelector(
                    `#${prefix}_comp${idx}_changementVie`
                  ).value = comp.changementVie;
                }
              }

              newContainer.querySelector(`.${prefix}_comp_vitesse`).value =
                comp.vitesse;
              const changementVitesseCheck = newContainer.querySelector(
                `#${prefix}_comp${idx}_changementVitesseCheck`
              );
              if (changementVitesseCheck) {
                changementVitesseCheck.checked = comp.changementVitesseCheck;
                if (comp.changementVitesseCheck) {
                  toggleChangementVitesseCompanion(prefix, idx);
                  newContainer.querySelector(
                    `#${prefix}_comp${idx}_changementVitesse`
                  ).value = comp.changementVitesse;
                }
              }

              newContainer.querySelector(`.${prefix}_comp_degats`).value =
                comp.degats;

              const changementDegatsCheck = newContainer.querySelector(
                `#${prefix}_comp${idx}_changementDegatsCheck`
              );
              if (changementDegatsCheck) {
                changementDegatsCheck.checked = comp.changementDegatsCheck;
                if (comp.changementDegatsCheck) {
                  toggleChangementDegatsCompanion(prefix, idx);
                  newContainer.querySelector(
                    `#${prefix}_comp${idx}_changementDegats`
                  ).value = comp.changementDegats;
                }
              }

              const capacitesInput = newContainer.querySelector(
                `#${prefix}_comp${idx}_capacites_input`
              );
              if (capacitesInput) {
                capacitesInput.value = comp.capacites;
                parseCapacitesInvocations(prefix, idx);
              }
            }
          }
        });
      }

      //       function parseCapacitesInvocations(prefix, idx) {
      //         const input = document.getElementById(
      //           `${prefix}_comp${idx}_capacites_input`
      //         ).value;
      //         const container = document.getElementById(
      //           `${prefix}_comp${idx}_capacites`
      //         );
      //         container.innerHTML = ""; // Reset

      //         // Traiter les lignes une par une
      //         const lines = input.split("\n").filter((l) => l.trim() !== "");
      //         let currentLines = [];

      //         for (let i = 0; i < lines.length; i++) {
      //           if (lines[i].trim() === "@not") {
      //             // Si on trouve @not, on fusionne la ligne précédente avec la suivante
      //             if (currentLines.length > 0 && i + 1 < lines.length) {
      //               const lastLine = currentLines.pop();
      //               currentLines.push(lastLine + "\n" + lines[i + 1]);
      //               i++; // Sauter la ligne suivante
      //             }
      //           } else {
      //             currentLines.push(lines[i]);
      //           }
      //         }

      //         currentLines.forEach((line, index) => {
      //           // Nettoyer les éventuels @not restants
      //           const cleanLine = line
      //             .split("\n")
      //             .filter((l) => l.trim() !== "@not")
      //             .join("\n");

      //           // Vérifier si la ligne contient un spoiler
      //           if (
      //             cleanLine.includes("[spoiler]") &&
      //             cleanLine.includes("[/spoiler]")
      //           ) {
      //             // Pour les lignes avec spoiler, ajouter directement le texte sans créer de <li>
      //             const escapedLine = escapeHtml(cleanLine);
      //             container.innerHTML += `<p>${escapedLine}</p>`;
      //             return; // Passer à la ligne suivante
      //           }

      //           // Pour les lignes normales, ne prendre en compte que le premier ":" qui n'est pas dans un spoiler
      //           let firstColonIndex = -1;
      //           let inSpoiler = false;

      //           for (let i = 0; i < cleanLine.length; i++) {
      //             if (cleanLine.substring(i, i + 9) === "[spoiler]") {
      //               inSpoiler = true;
      //               i += 8;
      //             } else if (cleanLine.substring(i, i + 10) === "[/spoiler]") {
      //               inSpoiler = false;
      //               i += 9;
      //             } else if (cleanLine[i] === ":" && !inSpoiler) {
      //               firstColonIndex = i;
      //               break;
      //             }
      //           }

      //           // Continuer avec le traitement normal pour les lignes sans spoiler
      //           if (firstColonIndex !== -1) {
      //             const titre = cleanLine.substring(0, firstColonIndex).trim();
      //             const description = cleanLine.substring(firstColonIndex + 1).trim();

      //             // Échapper les caractères spéciaux pour l'HTML
      //             const escapedTitre = escapeHtml(titre);
      //             const escapedDescription = escapeHtml(description);

      //             container.innerHTML += `
      // <div class="capacite-container">
      // <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="${escapedTitre}">
      // <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedDescription}">
      // <p><strong><em>${escapedTitre}</em></strong> : ${escapedDescription}</p>
      // <label>État :
      // <select class="${prefix}_comp${idx}_classeCapacite">
      // <option value="capacité_spéciale">Neutre</option>
      // <option value="capacité_spéciale active">Active</option>
      // <option value="capacité_spéciale passive">Passive</option>
      // <option value="capacité_spéciale bloquée">Bloquée</option>
      // <option value="capacité_spéciale utilisée">Utilisée</option>
      // <option value="capacité_spéciale annulée">Annulée</option>
      // <option value="capacité_spéciale inactive">Inactive</option>
      // </select>
      // </label>
      // </div>
      // `;
      //           } else {
      //             // Si pas de ":", traiter comme une capacité sans titre
      //             const escapedLine = escapeHtml(cleanLine);

      //             container.innerHTML += `
      // <div class="capacite-container">
      // <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="Capacité ${
      //               index + 1
      //             }">
      // <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedLine}">
      // <p><strong><em>Capacité ${index + 1}</em></strong> : ${escapedLine}</p>
      // <label>État :
      // <select class="${prefix}_comp${idx}_classeCapacite">
      // <option value="capacité_spéciale">Neutre</option>
      // <option value="capacité_spéciale active">Active</option>
      // <option value="capacité_spéciale passive">Passive</option>
      // <option value="capacité_spéciale bloquée">Bloquée</option>
      // <option value="capacité_spéciale utilisée">Utilisée</option>
      // <option value="capacité_spéciale annulée">Annulée</option>
      // <option value="capacité_spéciale inactive">Inactive</option>
      // </select>
      // </label>
      // </div>
      // `;
      //           }
      //         });
      //       }

      function parseCapacitesInvocations(prefix, idx) {
        const input = document.getElementById(
          `${prefix}_comp${idx}_capacites_input`
        ).value;
        const container = document.getElementById(
          `${prefix}_comp${idx}_capacites`
        );
        container.innerHTML = ""; // Reset

        const lines = input
          .split("\n")
          .map((l) => l.trim())
          .filter((l) => l !== "");

        const entries = [];
        let currentLine = null;

        lines.forEach((line) => {
          if (line.startsWith("x ")) {
            if (currentLine !== null) {
              entries.push(currentLine);
            }
            currentLine = line.substring(2); // Retire le "x "
          } else if (currentLine !== null) {
            currentLine += "\n" + line;
          } else {
            // Si pas de "x" au début, traiter comme une ligne normale
            currentLine = line;
          }
        });

        if (currentLine !== null) {
          entries.push(currentLine);
        }

        entries.forEach((entry, index) => {
          const firstColonIndex = entry.indexOf(":");

          if (firstColonIndex !== -1) {
            const titre = entry.substring(0, firstColonIndex).trim();
            const description = entry.substring(firstColonIndex + 1).trim();
            const escapedTitre = escapeHtml(titre);
            const escapedDescription = escapeHtml(description);

            container.innerHTML += `
                  <li>
                  <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="${escapedTitre}">
                  <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedDescription}">
                  <em>${escapedTitre}</em> : ${escapedDescription}
                  <br>
                  <label>État :
                  <select class="${prefix}_comp${idx}_classeCapacite">
                  <option value="capacité_spéciale">Neutre</option>
                  <option value="capacité_spéciale active">Active</option>
                  <option value="capacité_spéciale passive">Passive</option>
                  <option value="capacité_spéciale bloquée">Bloquée</option>
                  <option value="capacité_spéciale utilisée">Utilisée</option>
                  <option value="capacité_spéciale annulée">Annulée</option>
                  <option value="capacité_spéciale inactive">Inactive</option>
                  </select>
                  </label>
                  </li>`;
          } else {
            const escapedLine = escapeHtml(entry);
            container.innerHTML += `
                  <li>
                  <input type="hidden" class="${prefix}_comp${idx}_titreCapacite" value="Capacité ${
              index + 1
            }">
                  <input type="hidden" class="${prefix}_comp${idx}_descriptionCapacite" value="${escapedLine}">
                  <em>Capacité ${index + 1}</em> : ${escapedLine}
                  <br>
                  <label>État :
                  <select class="${prefix}_comp${idx}_classeCapacite">
                  <option value="capacité_spéciale">Neutre</option>
                  <option value="capacité_spéciale active">Active</option>
                  <option value="capacité_spéciale passive">Passive</option>
                  <option value="capacité_spéciale bloquée">Bloquée</option>
                  <option value="capacité_spéciale utilisée">Utilisée</option>
                  <option value="capacité_spéciale annulée">Annulée</option>
                  <option value="capacité_spéciale inactive">Inactive</option>
                  </select>
                  </label>
                  </li>`;
          }
        });
      }

      function extractCharacter(prefix) {
        let html = `\n${
          document.getElementById(`${prefix}_classe`).value === "boss"
            ? `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }"> <i class="icon boss" title="{BOSS}"></i> `
            : document.getElementById(`${prefix}_classe`).value === "archi-boss"
            ? `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }"> <i class="icon archi-boss" title="{ARCHI-BOSS}"></i> `
            : `<strong class="${
                document.getElementById(`${prefix}_classe`).value
              }">`
        }${
          document.getElementById(`${prefix}_nom`).value
        }</strong> : <strong class="vitalité">${
          document.getElementById(`${prefix}_vitalite`).value
        }</strong>`;

        if (document.getElementById(`${prefix}_changementVieCheck`).checked) {
          const valeur = document.getElementById(
            `${prefix}_changementVie`
          ).value;
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          }
        }

        html += `\n<span class="bestiaire-champ">Vitesse</span> : <strong class="vitesse">${
          document.getElementById(`${prefix}_vitesse`).value
        }</strong>`;

        if (
          document.getElementById(`${prefix}_changementVitesseCheck`).checked
        ) {
          const valeur = document.getElementById(
            `${prefix}_changementVitesse`
          ).value;
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          }
        }

        if (document.getElementById(`${prefix}_corrompu`).checked) {
          html += `\n<span class="bestiaire-champ">Absorption</span> : <strong class="dégâts">${
            document.getElementById(`${prefix}_absorption`).value
          }%</strong>`;
        }

        html += `\n<span class="bestiaire-champ">Dégâts</span> : <strong class="dégâts">${
          document.getElementById(`${prefix}_degats`).value
        }</strong>`;

        if (
          document.getElementById(`${prefix}_changementDegatsCheck`).checked
        ) {
          const valeur = document.getElementById(
            `${prefix}_changementDegats`
          ).value;
          if (valeur.startsWith("-")) {
            html += ` <strong class="stat-malus">${valeur}</strong>`;
          } else {
            html += ` <strong class="stat-bonus">${valeur}</strong>`;
          }
        }

        html += `\n<span class="bestiaire-champ">Capacités spéciales</span> :`;

        const titres = Array.from(
          document.getElementsByClassName(`${prefix}_titreCapacite`)
        );
        const descs = Array.from(
          document.getElementsByClassName(`${prefix}_descriptionCapacite`)
        );
        const classes = Array.from(
          document.getElementsByClassName(`${prefix}_classeCapacite`)
        );

        if (titres.length > 0) {
          html += `\n<ul>`;
          for (let i = 0; i < titres.length; i++) {
            const titreNettoye = titres[i].value.replace(/^x\s*/i, "");
            html += `<li class="${classes[i].value}"><em>${titreNettoye}</em> : ${descs[i].value}</li>\n`;
          }
          html += `</ul>`;
        } else {
          html += ` <em>Aucune capacité spéciale</em>`;
        }

        // Partie compagnon

        const noms = document.querySelectorAll(`.${prefix}_comp_nom`);
        const races = document.querySelectorAll(`.${prefix}_comp_race`);
        noms.forEach((compNom, idx) => {
          const race =
            document.querySelectorAll(`.${prefix}_comp_race`)[idx]?.value ||
            "Compagnon"; // Sélectionner la classe pour chaque compagnon
          const vit = document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx]
            .value;
          const vitess = document.querySelectorAll(`.${prefix}_comp_vitesse`)[
            idx
          ].value;
          const deg = document.querySelectorAll(`.${prefix}_comp_degats`)[idx]
            .value;

          html += `\n<strong class="${race}">${compNom.value}</strong> : <strong class="vitalité">${vit}</strong>`;

          // Ajouter les bonus/malus de vie
          if (
            document.getElementById(`${prefix}_comp${idx}_changementVieCheck`)
              .checked
          ) {
            const valeur = document.getElementById(
              `${prefix}_comp${idx}_changementVie`
            ).value;
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            }
          }

          html += `\n<span class="bestiaire-champ">Vitesse</span> : <strong class="vitesse">${vitess}</strong>`;

          // Ajouter les bonus/malus de vitesse
          if (
            document.getElementById(
              `${prefix}_comp${idx}_changementVitesseCheck`
            ).checked
          ) {
            const valeur = document.getElementById(
              `${prefix}_comp${idx}_changementVitesse`
            ).value;
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            }
          }

          html += `\n<span class="bestiaire-champ">Dégâts</span> : <strong class="dégâts">${deg}</strong>`;

          // Ajouter les bonus/malus de dégâts
          if (
            document.getElementById(
              `${prefix}_comp${idx}_changementDegatsCheck`
            ).checked
          ) {
            const valeur = document.getElementById(
              `${prefix}_comp${idx}_changementDegats`
            ).value;
            if (valeur.startsWith("-")) {
              html += ` <strong class="stat-malus">${valeur}</strong>`;
            } else {
              html += ` <strong class="stat-bonus">${valeur}</strong>`;
            }
          }

          html += `\n<span class="bestiaire-champ">Capacités spéciales</span> : `;

          const comp_titles = document.querySelectorAll(
            `.${prefix}_comp${idx}_titreCapacite`
          );
          const comp_descs = document.querySelectorAll(
            `.${prefix}_comp${idx}_descriptionCapacite`
          );
          const comp_classes = document.querySelectorAll(
            `.${prefix}_comp${idx}_classeCapacite`
          );

          // Correction de "lenght" en "length"
          if (comp_titles.length > 0) {
            html += `\n<ul>`;
            for (let i = 0; i < comp_titles.length; i++) {
              html += `<li class="${comp_classes[i].value}"><em>${comp_titles[i].value}</em> : ${comp_descs[i].value}</li>\n`;
            }
            html += `</ul>`;
          } else {
            html += ` <em>Aucune capacité spéciale</em>`;
          }
        });
        return html;
      }

      function calculerVitesseTotale(prefix) {
        let totalVitesse = parseInt(
          document.getElementById(`${prefix}_vitesse`).value || 0
        );
        const compagnons = document.querySelectorAll(`.${prefix}_comp_vitesse`);
        compagnons.forEach((v) => (totalVitesse += parseInt(v.value || 0)));
        return totalVitesse;
      }

      function genererHTML() {
        const nb1 = parseInt(document.getElementById("nbGroupe1").value);
        const nb2 = parseInt(document.getElementById("nbGroupe2").value);

        let vitesseGroupe1 = 0;
        let vitesseGroupe2 = 0;

        let htmlG1 = ``;
        for (let i = 0; i < nb1; i++) {
          const prefix = `g1_p${i}`;
          htmlG1 += extractCharacter(prefix) + "\n";
          vitesseGroupe1 += calculerVitesseTotale(prefix);
        }

        let vitesseG1 =
          nb1 > 1
            ? `Vitesse de Groupe 1 : ${vitesseGroupe1}`
            : `Vitesse de ${
                document.getElementById("g1_p0_nom").value
              } : ${vitesseGroupe1}`;

        let htmlG2 = ``;
        for (let i = 0; i < nb2; i++) {
          const prefix = `g2_p${i}`;
          htmlG2 += extractCharacter(prefix) + "\n";
          vitesseGroupe2 += calculerVitesseTotale(prefix);
        }

        let vitesseG2 =
          nb2 > 1
            ? `Vitesse de Groupe 2 : ${vitesseGroupe2}`
            : `Vitesse de ${
                document.getElementById("g2_p0_nom").value
              } : ${vitesseGroupe2}`;

        const commence =
          vitesseGroupe1 >= vitesseGroupe2
            ? nb1 > 1
              ? "Groupe 1"
              : document.getElementById("g1_p0_nom").value
            : nb2 > 1
            ? "Groupe 2"
            : document.getElementById("g2_p0_nom").value;

        const headerTitle =
          nb1 > 1 && nb2 > 1
            ? "Groupe 1 contre Groupe 2"
            : `${
                nb1 === 1
                  ? document.getElementById("g1_p0_nom").value
                  : "Groupe 1"
              } contre ${
                nb2 === 1
                  ? document.getElementById("g2_p0_nom").value
                  : "Groupe 2"
              }`;

        const header = `<div class="titre">${headerTitle}</div>

                  <em>${commence} commence le combat</em>`;

        document.getElementById(
          "resultat"
        ).value = `${header}\n\n${vitesseG1}\n${htmlG1}\n\n<div class="combat-séparation">Contre</div>\n\n${vitesseG2}\n${htmlG2}`;
      }

      function toggleAbsorption(prefix) {
        const bloc = document.getElementById(`${prefix}_absorptionBloc`);
        const isChecked = document.getElementById(`${prefix}_corrompu`).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementVie(prefix) {
        const bloc = document.getElementById(`${prefix}_changementVieBloc`);
        const isChecked = document.getElementById(
          `${prefix}_changementVieCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementVitesse(prefix) {
        const bloc = document.getElementById(`${prefix}_changementVitesseBloc`);
        const isChecked = document.getElementById(
          `${prefix}_changementVitesseCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementDegats(prefix) {
        const bloc = document.getElementById(`${prefix}_changementDegatsBloc`);
        const isChecked = document.getElementById(
          `${prefix}_changementDegatsCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementVieCompanion(prefix, idx) {
        const bloc = document.getElementById(
          `${prefix}_comp${idx}_changementVieBloc`
        );
        const isChecked = document.getElementById(
          `${prefix}_comp${idx}_changementVieCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementVitesseCompanion(prefix, idx) {
        const bloc = document.getElementById(
          `${prefix}_comp${idx}_changementVitesseBloc`
        );
        const isChecked = document.getElementById(
          `${prefix}_comp${idx}_changementVitesseCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function toggleChangementDegatsCompanion(prefix, idx) {
        const bloc = document.getElementById(
          `${prefix}_comp${idx}_changementDegatsBloc`
        );
        const isChecked = document.getElementById(
          `${prefix}_comp${idx}_changementDegatsCheck`
        ).checked;
        bloc.style.display = isChecked ? "block" : "none";
      }

      function collecterPersonnage(prefix) {
        const personnage = {
          nom: document.getElementById(`${prefix}_nom`).value,
          race: document.getElementById(`${prefix}_classe`).value,
          vitalite: document.getElementById(`${prefix}_vitalite`).value,
          // changementVie: document.getElementById(`${prefix}_changementVie`)
          // .value,
          vitesse: document.getElementById(`${prefix}_vitesse`).value,
          degats: document.getElementById(`${prefix}_degats`).value,
          corrompu: document.getElementById(`${prefix}_corrompu`).checked,
          absorption: document.getElementById(`${prefix}_absorption`).value,
          capacites: collecterCapacites(prefix),
          invocations: collecterInvocations(prefix),
        };
        return personnage;
      }

      function collecterCapacites(prefix) {
        const capacites = [];
        const titres = document.getElementsByClassName(
          `${prefix}_titreCapacite`
        );
        const descs = document.getElementsByClassName(
          `${prefix}_descriptionCapacite`
        );
        const classes = document.getElementsByClassName(
          `${prefix}_classeCapacite`
        );

        for (let i = 0; i < titres.length; i++) {
          const isNumberedCapacity = titres[i].value.startsWith("Capacité ");
          const titre = isNumberedCapacity
            ? titres[i].value
            : `x ${titres[i].value}`;

          capacites.push({
            titre: titre,
            description: descs[i].value,
            etat: classes[i].value,
          });
        }
        return capacites;
      }

      function collecterInvocations(prefix) {
        const invocations = [];
        const noms = document.querySelectorAll(`.${prefix}_comp_nom`);

        noms.forEach((_, idx) => {
          const invocation = {
            // Garder uniquement les données de base dans le JSON
            nom: document.querySelectorAll(`.${prefix}_comp_nom`)[idx].value,
            race: document.querySelectorAll(`.${prefix}_comp_race`)[idx].value,
            vitalite: document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx]
              .value,
            vitesse: document.querySelectorAll(`.${prefix}_comp_vitesse`)[idx]
              .value,
            degats: document.querySelectorAll(`.${prefix}_comp_degats`)[idx]
              .value,
            capacites: collecterCapacitesInvocation(prefix, idx),
          };

          // Stocker les données temporaires séparément du JSON
          (invocation._tempData = {
            changementVieCheck: document.getElementById(
              `${prefix}_comp${idx}_changementVieCheck`
            )?.checked,
            changementVie: document.getElementById(
              `${prefix}_comp${idx}_changementVie`
            )?.value,
            changementVitesseCheck: document.getElementById(
              `${prefix}_comp${idx}_changementVitesseCheck`
            )?.checked,
            changementVitesse: document.getElementById(
              `${prefix}_comp${idx}_changementVitesse`
            )?.value,
            changementDegatsCheck: document.getElementById(
              `${prefix}_comp${idx}_changementDegatsCheck`
            )?.checked,
            changementDegats: document.getElementById(
              `${prefix}_comp${idx}_changementDegats`
            )?.value,
          }),
            invocations.push(invocation);
        });

        // Ne retourner que les données de base, sans _tempData
        return invocations.map(({ _tempData, ...rest }) => rest);
      }

      function collecterCapacitesInvocation(prefix, idx) {
        const capacites = [];
        const titres = document.querySelectorAll(
          `.${prefix}_comp${idx}_titreCapacite`
        );
        const descs = document.querySelectorAll(
          `.${prefix}_comp${idx}_descriptionCapacite`
        );
        const classes = document.querySelectorAll(
          `.${prefix}_comp${idx}_classeCapacite`
        );

        for (let i = 0; i < titres.length; i++) {
          const isNumberedCapacity = titres[i].value.startsWith("Capacité ");
          const titre = isNumberedCapacity
            ? titres[i].value
            : `x ${titres[i].value}`;

          capacites.push({
            titre: titre,
            titre: titres[i].value,
            description: descs[i].value,
            etat: classes[i].value,
          });
        }
        return capacites;
      }

      function exporterPersonnage(prefix) {
        const personnage = collecterPersonnage(prefix);
        const nom = personnage.nom || "personnage";
        const blob = new Blob([JSON.stringify(personnage, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${nom}.json`;
        a.click();
      }

      function importerPersonnage(event, prefix) {
        const fichier = event.target.files[0];
        if (!fichier) return;

        // Vider tous les champs avant l'importation
        viderPersonnage(prefix);

        const reader = new FileReader();
        reader.onload = function (e) {
          const personnage = JSON.parse(e.target.result);
          remplirPersonnage(prefix, personnage);
        };
        reader.readAsText(fichier);
      }

      function viderPersonnage(prefix) {
        // Vider les champs principaux
        document.getElementById(`${prefix}_nom`).value = "";
        document.getElementById(`${prefix}_classe`).value = "humain"; // Valeur par défaut
        document.getElementById(`${prefix}_vitalite`).value = "";
        document.getElementById(`${prefix}_vitesse`).value = "";
        document.getElementById(`${prefix}_degats`).value = "";

        // Réinitialiser les checkboxes et leurs blocs associés
        document.getElementById(`${prefix}_changementVieCheck`).checked = false;
        document.getElementById(
          `${prefix}_changementVitesseCheck`
        ).checked = false;
        document.getElementById(
          `${prefix}_changementDegatsCheck`
        ).checked = false;
        document.getElementById(`${prefix}_corrompu`).checked = false;

        // Vider et cacher les blocs de bonus/malus
        document.getElementById(`${prefix}_changementVie`).value = "";
        document.getElementById(`${prefix}_changementVitesse`).value = "";
        document.getElementById(`${prefix}_changementDegats`).value = "";
        document.getElementById(`${prefix}_absorption`).value = "0";

        document.getElementById(`${prefix}_changementVieBloc`).style.display =
          "none";
        document.getElementById(
          `${prefix}_changementVitesseBloc`
        ).style.display = "none";
        document.getElementById(
          `${prefix}_changementDegatsBloc`
        ).style.display = "none";
        document.getElementById(`${prefix}_absorptionBloc`).style.display =
          "none";

        // Vider les capacités
        document.getElementById(`${prefix}_capacites_input`).value = "";
        document.getElementById(`${prefix}_capacites`).innerHTML = "";

        // Réinitialiser les invocations
        document.getElementById(`${prefix}_nbCompagnons`).value = "0";
        document.getElementById(`${prefix}_compagnons`).innerHTML = "";
      }

      function remplirPersonnage(prefix, data) {
        // Remplir les champs de base
        document.getElementById(`${prefix}_nom`).value = data.nom;
        document.getElementById(`${prefix}_classe`).value = data.race;
        document.getElementById(`${prefix}_vitalite`).value = data.vitalite;
        document.getElementById(`${prefix}_changementVieCheck`).checked =
          data.changementVie;
        document.getElementById(`${prefix}_vitesse`).value = data.vitesse;
        document.getElementById(`${prefix}_changementVitesseCheck`).checked =
          data.changementVitesse;
        document.getElementById(`${prefix}_degats`).value = data.degats;
        document.getElementById(`${prefix}_changementDegatsCheck`).checked =
          data.changementDegats;
        document.getElementById(`${prefix}_corrompu`).checked = data.corrompu;

        // Gérer l'absorption si corrompu
        if (data.corrompu) {
          document.getElementById(`${prefix}_absorption`).value =
            data.absorption;
          toggleAbsorption(prefix); // Assurez-vous que le bloc d'absorption est visible
        }

        // Gérer les malus/bonus de Vie si activé
        if (data.changementVie) {
          document.getElementById(`${prefix}_changementVie`).value =
            data.changementVie;
          toggleChangementVie(prefix); // Assurez-vous que le bloc de Malus/Bonus Vie est visible
        }

        // Gérer les malus/bonus de Vitesse si activé
        if (data.changementVitesse) {
          document.getElementById(`${prefix}_changementVitesse`).value =
            data.changementVitesse;
          toggleChangementVitesse(prefix); // Assurez-vous que le bloc de Malus/Bonus Vitesse est visible
        }

        // Gérer les malus/bonus de Degats si activé
        if (data.changementDegats) {
          document.getElementById(`${prefix}_changementDegats`).value =
            data.changementDegats;
          toggleChangementDegats(prefix); // Assurez-vous que le bloc de Malus/Bonus Degats est visible
        }

        // Remplir les capacités
        const capacitesTexte = data.capacites
          .map((c) => {
            if (c.titre.startsWith("Capacité ") || c.titre.startsWith("x ")) {
              return `${c.titre} : ${c.description}`;
            }
            return `x ${c.titre} : ${c.description}`;
          })
          .join("\n");
        document.getElementById(`${prefix}_capacites_input`).value =
          capacitesTexte;
        parseCapacites(prefix);

        // Mettre à jour les états des capacités
        const classes = document.getElementsByClassName(
          `${prefix}_classeCapacite`
        );
        data.capacites.forEach((c, i) => {
          if (classes[i]) classes[i].value = c.etat;
        });

        // Gérer les invocations
        if (data.invocations && data.invocations.length > 0) {
          document.getElementById(`${prefix}_nbCompagnons`).value =
            data.invocations.length;
          updateCompanions(prefix);
          data.invocations.forEach((inv, idx) => {
            remplirInvocation(prefix, idx, inv);
          });
        }
      }

      function remplirInvocation(prefix, idx, data) {
        const inputs = {
          nom: document.querySelectorAll(`.${prefix}_comp_nom`)[idx],
          race: document.querySelectorAll(`.${prefix}_comp_race`)[idx],
          vitalite: document.querySelectorAll(`.${prefix}_comp_vitalite`)[idx],
          vitesse: document.querySelectorAll(`.${prefix}_comp_vitesse`)[idx],
          degats: document.querySelectorAll(`.${prefix}_comp_degats`)[idx],
        };

        // Vérifier que tous les éléments existent avant de les remplir
        if (Object.values(inputs).every((el) => el)) {
          Object.entries(inputs).forEach(([key, el]) => (el.value = data[key]));

          // Restaurer les données temporaires si elles existent
          if (data._tempData) {
            // Bonus/Malus Vie
            const changementVieCheck = document.getElementById(
              `${prefix}_comp${idx}_changementVieCheck`
            );
            if (changementVieCheck) {
              changementVieCheck.checked = data._tempData.changementVieCheck;
              if (data._tempData.changementVieCheck) {
                toggleChangementVieCompanion(prefix, idx);
                document.getElementById(
                  `${prefix}_comp${idx}_changementVie`
                ).value = data._tempData.changementVie;
              }
            }

            // Bonus/Malus Vitesse
            const changementVitesseCheck = document.getElementById(
              `${prefix}_comp${idx}_changementVitesseCheck`
            );
            if (changementVitesseCheck) {
              changementVitesseCheck.checked =
                data._tempData.changementVitesseCheck;
              if (data._tempData.changementVitesseCheck) {
                toggleChangementVitesseCompanion(prefix, idx);
                document.getElementById(
                  `${prefix}_comp${idx}_changementVitesse`
                ).value = data._tempData.changementVitesse;
              }
            }

            // Bonus/Malus Dégâts
            const changementDegatsCheck = document.getElementById(
              `${prefix}_comp${idx}_changementDegatsCheck`
            );
            if (changementDegatsCheck) {
              changementDegatsCheck.checked =
                data._tempData.changementDegatsCheck;
              if (data._tempData.changementDegatsCheck) {
                toggleChangementDegatsCompanion(prefix, idx);
                document.getElementById(
                  `${prefix}_comp${idx}_changementDegats`
                ).value = data._tempData.changementDegats;
              }
            }
          }

          // Remplir les capacités de l'invocation
          const capacitesTexte = data.capacites
            .map((c) => {
              if (c.titre.startsWith("Capacité ") || c.titre.startsWith("x ")) {
                return `${c.titre} : ${c.description}`;
              }
              return `x ${c.titre} : ${c.description}`;
            })
            .join("\n");
          const inputCapacites = document.getElementById(
            `${prefix}_comp${idx}_capacites_input`
          );
          if (inputCapacites) {
            inputCapacites.value = capacitesTexte;
            parseCapacitesInvocations(prefix, idx);

            // Mettre à jour les états des capacités
            const classes = document.querySelectorAll(
              `.${prefix}_comp${idx}_classeCapacite`
            );
            data.capacites.forEach((c, i) => {
              if (classes[i]) classes[i].value = c.etat;
            });
          }
        }
      }

      window.onload = function () {
        genererFormulairesGroupes();
      };
    </script>
  </body>
</html>
